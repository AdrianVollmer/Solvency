{% extends "base.html" %}
{% import "macros/ui.html" as ui %}

{% block content %}
{% call ui::page_container(max_width="max-w-lg") %}
    {% if account.is_some() %}
    {% call ui::page_header(title=title.as_str(), back_url="/accounts", back_label="Accounts", subtitle="Update account details") %}{% endcall %}
    {% else %}
    {% call ui::page_header(title=title.as_str(), back_url="/accounts", back_label="Accounts", subtitle="Create a new account to track") %}{% endcall %}
    {% endif %}

    {% call ui::card() %}
        <form action="{% if let Some(acc) = account %}/accounts/{{ acc.id }}/update{% else %}/accounts/create{% endif %}" method="POST" class="space-y-4">
            {% if let Some(acc) = account %}
            <div class="mb-4 p-3 bg-neutral-100 dark:bg-neutral-700 rounded-lg">
                <p class="text-sm text-neutral-600 dark:text-neutral-300">
                    <span class="font-medium">Database ID:</span> {{ acc.id }}
                </p>
                <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">Use this ID when importing data to associate with this account.</p>
            </div>
            {% endif %}

            <div>
                <label for="account-name" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Name</label>
                <input type="text" id="account-name" name="name" required
                    class="input w-full"
                    placeholder="e.g., Main Checking, Brokerage"
                    value="{% if let Some(acc) = account %}{{ acc.name }}{% endif %}">
            </div>

            <div>
                <label for="account-type" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Type</label>
                <select id="account-type" name="account_type" class="input w-full">
                    <option value="Cash" {% if let Some(acc) = account %}{% if acc.account_type.as_str() == "Cash" %}selected{% endif %}{% endif %}>Cash</option>
                    <option value="Securities" {% if let Some(acc) = account %}{% if acc.account_type.as_str() == "Securities" %}selected{% endif %}{% endif %}>Securities</option>
                </select>
                <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">
                    Cash accounts can be linked to transactions. Securities accounts can be linked to trading activities.
                </p>
            </div>

            <div class="flex gap-3 pt-4">
                <a href="/accounts" class="btn btn-secondary flex-1 text-center">
                    Cancel
                </a>
                <button type="submit" class="btn btn-primary flex-1">
                    {% if account.is_some() %}Update{% else %}Add{% endif %} Account
                </button>
            </div>
        </form>

        {% if let Some(acc) = account %}
        <div class="mt-6 pt-6 border-t border-neutral-200 dark:border-neutral-700">
            <h3 class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3">Danger Zone</h3>
            <button
                type="button"
                onclick="deleteAccount({{ acc.id }})"
                class="btn btn-secondary text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 border-red-200 dark:border-red-800 w-full flex items-center justify-center gap-2">
                <span class="icon-sm" aria-hidden="true">{{ icons.get("trash-2")|safe }}</span>
                Delete Account
            </button>
            <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-2">
                This will remove the account. Transactions and trading activities linked to this account will have their account reference cleared.
            </p>
        </div>
        {% endif %}
    {% endcall %}
{% endcall %}

{% if account.is_some() %}
<script>
async function deleteAccount(id) {
    if (!confirm('Are you sure you want to delete this account?')) return;
    try {
        const response = await fetch('/accounts/' + id, {
            method: 'DELETE',
            headers: {
                'X-XSRF-TOKEN': '{{ xsrf_token }}'
            }
        });
        if (response.ok) {
            window.location.href = '/accounts';
        } else {
            showAlertModal('Failed to delete account');
        }
    } catch (e) {
        showAlertModal('Failed to delete account: ' + e.message);
    }
}
</script>
{% endif %}
{% endblock %}
