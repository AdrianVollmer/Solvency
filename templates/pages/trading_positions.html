{% extends "base.html" %}
{% import "macros/table.html" as table %}
{% import "macros/ui.html" as ui %}

{% block content %}
<div class="space-y-6">
    {% call ui::page_header(title="Positions", subtitle="Calculated from your trading activities") %}{% endcall %}

    {% if positions.is_empty() %}
    {% call ui::empty_state_action(icon="trending-up", title="No positions yet", description="Import or add trading activities to see your positions", action_url="/trading/activities", action_label="Add Activity") %}{% endcall %}
    {% else %}

    {# Cash Positions #}
    {% if !cash_positions.is_empty() %}
    {% call ui::card(class="", overflow="overflow-hidden") %}
        <div class="px-6 py-4 border-b border-neutral-200 dark:border-neutral-700">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">Cash</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-neutral-200 dark:divide-neutral-700">
                <thead class="bg-neutral-50 dark:bg-neutral-900">
                    <tr>
                        {% call table::th(label="Currency", align="left") %}{% endcall %}
                        {% call table::th(label="Balance", align="right") %}{% endcall %}
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-neutral-800 divide-y divide-neutral-200 dark:divide-neutral-700">
                    {% for position in cash_positions %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-medium text-neutral-900 dark:text-white">{{ position.symbol }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-sm font-medium text-neutral-900 dark:text-white">{{ settings.format_money_neutral_with_currency(position.total_cost_cents, position.currency) }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endcall %}
    {% endif %}

    {# Security Positions #}
    {% if !security_positions.is_empty() %}
    {% call ui::card(class="", overflow="overflow-hidden") %}
        <div class="px-6 py-4 border-b border-neutral-200 dark:border-neutral-700 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">Securities</h2>
            <div class="flex items-center gap-4">
                <a href="/trading/positions/closed" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">View Closed Positions</a>
                <a href="/trading/market-data" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">Manage Market Data</a>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-neutral-200 dark:divide-neutral-700">
                <thead class="bg-neutral-50 dark:bg-neutral-900">
                    <tr>
                        {% call table::th_sort(label="Symbol", url="/trading/positions", sort_qs=sort.query_string_for_str("symbol"), indicator=sort.indicator_str("symbol"), align="left", extra="") %}{% endcall %}
                        {% call table::th_sort(label="Quantity", url="/trading/positions", sort_qs=sort.query_string_for_str("quantity"), indicator=sort.indicator_str("quantity"), align="right", extra="") %}{% endcall %}
                        {% call table::th_sort(label="Market Price", url="/trading/positions", sort_qs=sort.query_string_for_str("price"), indicator=sort.indicator_str("price"), align="right", extra="") %}{% endcall %}
                        {% call table::th_sort(label="Avg Cost", url="/trading/positions", sort_qs=sort.query_string_for_str("avgcost"), indicator=sort.indicator_str("avgcost"), align="right", extra="") %}{% endcall %}
                        {% call table::th_sort(label="Total Cost", url="/trading/positions", sort_qs=sort.query_string_for_str("totalcost"), indicator=sort.indicator_str("totalcost"), align="right", extra="") %}{% endcall %}
                        {% call table::th_sort(label="Current Value", url="/trading/positions", sort_qs=sort.query_string_for_str("value"), indicator=sort.indicator_str("value"), align="right", extra="") %}{% endcall %}
                        {% call table::th_sort(label="Unrealized G/L", url="/trading/positions", sort_qs=sort.query_string_for_str("gainloss"), indicator=sort.indicator_str("gainloss"), align="right", extra="") %}{% endcall %}
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-neutral-800 divide-y divide-neutral-200 dark:divide-neutral-700">
                    {% for pos in security_positions %}
                    <tr class="cursor-pointer hover:bg-neutral-50 dark:hover:bg-neutral-700/50 transition-colors" onclick="window.location.href='/trading/positions/{{ pos.position.symbol }}'">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-medium text-neutral-900 dark:text-white">{{ pos.position.symbol }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-sm text-neutral-900 dark:text-white">{{ pos.position.quantity_display() }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% match pos.current_price_cents %}
                            {% when Some with (cents) %}
                            {% if pos.price_is_approximated %}
                            <span class="text-sm text-yellow-600 dark:text-yellow-400 inline-flex items-center gap-1" title="Approximated from last BUY/SELL activity (no market data available)">
                                {{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}
                                <span class="icon-xs" aria-hidden="true">{{ icons.get("help-circle")|safe }}</span>
                            </span>
                            {% else %}
                            <span class="text-sm text-neutral-900 dark:text-white">{{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}</span>
                            {% endif %}
                            {% when None %}
                            <span class="text-sm text-neutral-400 dark:text-neutral-500 italic">-</span>
                            {% endmatch %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-sm text-neutral-600 dark:text-neutral-400">
                                {% match pos.position.average_cost_cents() %}
                                {% when Some with (cents) %}{{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}{% when None %}-{% endmatch %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-sm text-neutral-900 dark:text-white">{{ settings.format_money_neutral_with_currency(pos.position.total_cost_cents, pos.position.currency) }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% match pos.current_value_cents %}
                            {% when Some with (cents) %}
                            {% if pos.price_is_approximated %}
                            <span class="text-sm font-medium text-yellow-600 dark:text-yellow-400 inline-flex items-center gap-1" title="Approximated from last BUY/SELL activity (no market data available)">
                                {{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}
                                <span class="icon-xs" aria-hidden="true">{{ icons.get("help-circle")|safe }}</span>
                            </span>
                            {% else %}
                            <span class="text-sm font-medium text-neutral-900 dark:text-white">{{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}</span>
                            {% endif %}
                            {% when None %}
                            <span class="text-sm text-neutral-400 dark:text-neutral-500 italic">-</span>
                            {% endmatch %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% match pos.gain_loss_cents %}
                            {% when Some with (cents) %}
                            <div class="flex flex-col items-end">
                                <span class="text-sm font-medium {{ pos.gain_loss_color() }}">{{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}</span>
                                {% match pos.gain_loss_percent %}
                                {% when Some with (pct) %}
                                <span class="text-xs {{ pos.gain_loss_color() }}">{{ settings.format_percent(pct) }}</span>
                                {% when None %}{% endmatch %}
                            </div>
                            {% when None %}
                            <span class="text-sm text-neutral-400 dark:text-neutral-500 italic">-</span>
                            {% endmatch %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if total_current_value.is_some() %}
                <tfoot class="bg-neutral-50 dark:bg-neutral-900">
                    <tr>
                        <td colspan="4" class="px-6 py-3 text-right text-sm font-medium text-neutral-700 dark:text-neutral-300">Total</td>
                        <td class="px-6 py-3 text-right text-sm font-semibold text-neutral-900 dark:text-white">
                            {{ total_cost_formatted }}
                        </td>
                        <td class="px-6 py-3 text-right text-sm font-semibold text-neutral-900 dark:text-white">
                            {% match total_current_value_formatted %}
                            {% when Some with (val) %}{{ val }}
                            {% when None %}-{% endmatch %}
                        </td>
                        <td class="px-6 py-3 text-right">
                            {% match total_gain_loss_formatted %}
                            {% when Some with (gl) %}
                            <span class="text-sm font-semibold {{ total_gain_loss_color }}">{{ gl }}</span>
                            {% when None %}-{% endmatch %}
                        </td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    {% endcall %}
    {% endif %}

    {% endif %}
</div>
{% endblock %}
