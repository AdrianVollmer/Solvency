{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <div>
        <h1 class="page-title">Positions</h1>
        <p class="mt-1 text-muted">Calculated from your trading activities</p>
    </div>

    {% if positions.is_empty() %}
    <div class="bg-white dark:bg-neutral-800 rounded-xl border border-neutral-200 dark:border-neutral-700 p-8 text-center">
        <p class="text-neutral-500 dark:text-neutral-400">No positions yet. Import or add trading activities to see your positions.</p>
        <a href="/trading/activities" class="mt-4 inline-block btn btn-primary">Add Activity</a>
    </div>
    {% else %}

    <!-- Cash Positions -->
    {% if !cash_positions.is_empty() %}
    <div class="bg-white dark:bg-neutral-800 rounded-xl border border-neutral-200 dark:border-neutral-700 overflow-hidden">
        <div class="px-6 py-4 border-b border-neutral-200 dark:border-neutral-700">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">Cash</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-neutral-200 dark:divide-neutral-700">
                <thead class="bg-neutral-50 dark:bg-neutral-900">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">Currency</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">Balance</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-neutral-800 divide-y divide-neutral-200 dark:divide-neutral-700">
                    {% for position in cash_positions %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-medium text-neutral-900 dark:text-white">{{ position.symbol }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-sm font-medium text-neutral-900 dark:text-white">{{ settings.format_money_neutral_with_currency(position.total_cost_cents, position.currency) }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Security Positions -->
    {% if !security_positions.is_empty() %}
    <div class="bg-white dark:bg-neutral-800 rounded-xl border border-neutral-200 dark:border-neutral-700 overflow-hidden">
        <div class="px-6 py-4 border-b border-neutral-200 dark:border-neutral-700 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">Securities</h2>
            <div class="flex items-center gap-4">
                <a href="/trading/positions/closed" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">View Closed Positions</a>
                <a href="/trading/market-data" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">Manage Market Data</a>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-neutral-200 dark:divide-neutral-700">
                <thead class="bg-neutral-50 dark:bg-neutral-900">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                            <a href="/trading/positions?{{ sort.query_string_for_str("symbol") }}"
                               class="flex items-center gap-1 hover:text-neutral-700 dark:hover:text-neutral-200 cursor-pointer">
                                Symbol <span>{{ sort.indicator_str("symbol") }}</span>
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                            <a href="/trading/positions?{{ sort.query_string_for_str("quantity") }}"
                               class="flex items-center justify-end gap-1 hover:text-neutral-700 dark:hover:text-neutral-200 cursor-pointer">
                                Quantity <span>{{ sort.indicator_str("quantity") }}</span>
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                            <a href="/trading/positions?{{ sort.query_string_for_str("price") }}"
                               class="flex items-center justify-end gap-1 hover:text-neutral-700 dark:hover:text-neutral-200 cursor-pointer">
                                Price <span>{{ sort.indicator_str("price") }}</span>
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                            <a href="/trading/positions?{{ sort.query_string_for_str("avgcost") }}"
                               class="flex items-center justify-end gap-1 hover:text-neutral-700 dark:hover:text-neutral-200 cursor-pointer">
                                Avg Cost <span>{{ sort.indicator_str("avgcost") }}</span>
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                            <a href="/trading/positions?{{ sort.query_string_for_str("totalcost") }}"
                               class="flex items-center justify-end gap-1 hover:text-neutral-700 dark:hover:text-neutral-200 cursor-pointer">
                                Total Cost <span>{{ sort.indicator_str("totalcost") }}</span>
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                            <a href="/trading/positions?{{ sort.query_string_for_str("value") }}"
                               class="flex items-center justify-end gap-1 hover:text-neutral-700 dark:hover:text-neutral-200 cursor-pointer">
                                Current Value <span>{{ sort.indicator_str("value") }}</span>
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                            <a href="/trading/positions?{{ sort.query_string_for_str("gainloss") }}"
                               class="flex items-center justify-end gap-1 hover:text-neutral-700 dark:hover:text-neutral-200 cursor-pointer">
                                Gain/Loss <span>{{ sort.indicator_str("gainloss") }}</span>
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-neutral-800 divide-y divide-neutral-200 dark:divide-neutral-700">
                    {% for pos in security_positions %}
                    <tr class="cursor-pointer hover:bg-neutral-50 dark:hover:bg-neutral-700/50 transition-colors" onclick="window.location.href='/trading/positions/{{ pos.position.symbol }}'">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-medium text-neutral-900 dark:text-white">{{ pos.position.symbol }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-sm text-neutral-900 dark:text-white">{{ pos.position.quantity_display() }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% match pos.current_price_cents %}
                            {% when Some with (cents) %}
                            {% if pos.price_is_approximated %}
                            <span class="text-sm text-yellow-600 dark:text-yellow-400 inline-flex items-center gap-1" title="Approximated from last BUY/SELL activity (no market data available)">
                                {{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </span>
                            {% else %}
                            <span class="text-sm text-neutral-900 dark:text-white">{{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}</span>
                            {% endif %}
                            {% when None %}
                            <span class="text-sm text-neutral-400 dark:text-neutral-500 italic">-</span>
                            {% endmatch %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-sm text-neutral-600 dark:text-neutral-400">
                                {% match pos.position.average_cost_cents() %}
                                {% when Some with (cents) %}{{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}{% when None %}-{% endmatch %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-sm text-neutral-900 dark:text-white">{{ settings.format_money_neutral_with_currency(pos.position.total_cost_cents, pos.position.currency) }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% match pos.current_value_cents %}
                            {% when Some with (cents) %}
                            {% if pos.price_is_approximated %}
                            <span class="text-sm font-medium text-yellow-600 dark:text-yellow-400 inline-flex items-center gap-1" title="Approximated from last BUY/SELL activity (no market data available)">
                                {{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </span>
                            {% else %}
                            <span class="text-sm font-medium text-neutral-900 dark:text-white">{{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}</span>
                            {% endif %}
                            {% when None %}
                            <span class="text-sm text-neutral-400 dark:text-neutral-500 italic">-</span>
                            {% endmatch %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% match pos.gain_loss_cents %}
                            {% when Some with (cents) %}
                            <div class="flex flex-col items-end">
                                <span class="text-sm font-medium {{ pos.gain_loss_color() }}">{{ settings.format_money_neutral_with_currency(cents, pos.position.currency) }}</span>
                                {% match pos.gain_loss_percent %}
                                {% when Some with (pct) %}
                                <span class="text-xs {{ pos.gain_loss_color() }}">{{ settings.format_percent(pct) }}</span>
                                {% when None %}{% endmatch %}
                            </div>
                            {% when None %}
                            <span class="text-sm text-neutral-400 dark:text-neutral-500 italic">-</span>
                            {% endmatch %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if total_current_value.is_some() %}
                <tfoot class="bg-neutral-50 dark:bg-neutral-900">
                    <tr>
                        <td colspan="4" class="px-6 py-3 text-right text-sm font-medium text-neutral-700 dark:text-neutral-300">Total</td>
                        <td class="px-6 py-3 text-right text-sm font-semibold text-neutral-900 dark:text-white">
                            {{ total_cost_formatted }}
                        </td>
                        <td class="px-6 py-3 text-right text-sm font-semibold text-neutral-900 dark:text-white">
                            {% match total_current_value_formatted %}
                            {% when Some with (val) %}{{ val }}
                            {% when None %}-{% endmatch %}
                        </td>
                        <td class="px-6 py-3 text-right">
                            {% match total_gain_loss_formatted %}
                            {% when Some with (gl) %}
                            <span class="text-sm font-semibold {{ total_gain_loss_color }}">{{ gl }}</span>
                            {% when None %}-{% endmatch %}
                        </td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
    {% endif %}

    {% endif %}
</div>
{% endblock %}
