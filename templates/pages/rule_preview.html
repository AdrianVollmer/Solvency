{% extends "base.html" %}
{% import "macros/ui.html" as ui %}

{% block content %}
{% call ui::page_container(max_width="max-w-4xl") %}
    {% let back_url = format!("/rules/{}", self.rule.id) %}
    {% call ui::page_header(title="Preview Rule Application", back_url=back_url.as_str(), back_label="Rule Details") %}{% endcall %}

    {# Summary Card #}
    {% call ui::card() %}
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">{{ rule.name }}</h2>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                    {% if rule.action_type.as_str() == "assign_category" %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300{% else %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300{% endif %}">
                    {% if rule.action_type.as_str() == "assign_category" %}Assign Category{% else %}Assign Tag{% endif %}
                </span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                <div>
                    <span class="text-neutral-500 dark:text-neutral-400">Pattern</span>
                    <p class="font-mono text-neutral-900 dark:text-white">{{ rule.pattern }}</p>
                </div>
                <div>
                    <span class="text-neutral-500 dark:text-neutral-400">Target</span>
                    <p>
                        {% if rule.action_type.as_str() == "assign_category" %}
                            {% for cat in categories %}
                                {% if cat.category.id.to_string() == rule.action_value %}
                                    {% call ui::category_badge(color=cat.category.color.as_str(), name=cat.path.as_str()) %}{% endcall %}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% for tag in tags %}
                                {% if tag.id.to_string() == rule.action_value %}
                                    {% call ui::tag_badge(color=tag.color, name=tag.name) %}{% endcall %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </p>
                </div>
                <div>
                    <span class="text-neutral-500 dark:text-neutral-400">Scope</span>
                    <p class="text-neutral-900 dark:text-white">{% if scope == "uncategorized" %}Uncategorized only{% else %}All transactions{% endif %}</p>
                </div>
            </div>
        </div>
    {% endcall %}

    {# Match Results #}
    {% if matched.is_empty() %}
        {% call ui::empty_state(icon="search", title="No matching transactions") %}{% endcall %}
    {% else %}
        <div class="flex items-center justify-between">
            <p class="text-sm text-neutral-600 dark:text-neutral-400">
                <span class="font-semibold text-neutral-900 dark:text-white">{{ matched.len() }}</span>
                transaction{% if matched.len() != 1 %}s{% endif %} will be updated
            </p>
            <form action="/rules/{{ rule.id }}/apply" method="POST" class="flex gap-3">
                <input type="hidden" name="scope" value="{{ scope }}">
                <a href="/rules/{{ rule.id }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    Confirm &amp; Apply
                </button>
            </form>
        </div>

        {% call ui::card(class="", overflow="overflow-hidden") %}
            <table class="w-full">
                <thead>
                    <tr class="border-b border-neutral-200 dark:border-neutral-700 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                        <th class="px-4 py-3">Date</th>
                        <th class="px-4 py-3">Description</th>
                        <th class="px-4 py-3">Amount</th>
                        <th class="px-4 py-3">Current</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
                    {% for t in matched %}
                    <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-700/50">
                        <td class="px-4 py-3 text-sm text-neutral-600 dark:text-neutral-400 whitespace-nowrap">{{ t.transaction.date }}</td>
                        <td class="px-4 py-3 text-sm text-neutral-900 dark:text-white">{{ t.transaction.description }}</td>
                        <td class="px-4 py-3 text-sm font-mono whitespace-nowrap {% if t.transaction.is_income() %}text-green-600 dark:text-green-400{% else %}text-neutral-900 dark:text-white{% endif %}">
                            {{ t.transaction.amount_formatted() }}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {% if rule.action_type.as_str() == "assign_category" %}
                                {% match t.category_name %}
                                    {% when Some with (name) %}
                                        {% call ui::category_badge(color=t.category_color_or_default(), name=name) %}{% endcall %}
                                    {% when None %}
                                        <span class="text-neutral-400 dark:text-neutral-500 italic">None</span>
                                {% endmatch %}
                            {% else %}
                                {% if t.tags.is_empty() %}
                                    <span class="text-neutral-400 dark:text-neutral-500 italic">No tags</span>
                                {% else %}
                                    <div class="flex flex-wrap gap-1">
                                        {% for tag in t.tags %}
                                            {% call ui::tag_badge(color=tag.color, name=tag.name) %}{% endcall %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endcall %}

        <form action="/rules/{{ rule.id }}/apply" method="POST" class="flex justify-end gap-3">
            <input type="hidden" name="scope" value="{{ scope }}">
            <a href="/rules/{{ rule.id }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">
                Confirm &amp; Apply
            </button>
        </form>
    {% endif %}
{% endcall %}
{% endblock %}
