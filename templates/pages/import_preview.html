{% extends "base.html" %}
{% import "macros/ui.html" as ui %}

{% block content %}
{% call ui::page_container(max_width="max-w-4xl") %}
    {% call ui::page_header(title=title.as_str(), back_url=back_url.as_str(), back_label=resource_name.as_str()) %}{% endcall %}

    {# Summary #}
    <div class="flex items-center justify-between">
        <p class="text-sm text-neutral-600 dark:text-neutral-400">
            {% if ok_count > 0 %}
                <span class="font-semibold text-neutral-900 dark:text-white">{{ ok_count }}</span>
                {% if ok_count == 1 %}item{% else %}items{% endif %} will be imported{% if skip_count > 0 %},{% endif %}
            {% endif %}
            {% if skip_count > 0 %}
                <span class="font-semibold text-amber-600 dark:text-amber-400">{{ skip_count }}</span>
                will be skipped
            {% endif %}
            {% if ok_count == 0 && skip_count == 0 %}
                No items found in file.
            {% endif %}
        </p>
        {% if ok_count > 0 %}
            <div class="flex gap-3">
                <a href="{{ back_url }}" class="btn btn-secondary">Cancel</a>
                <button type="button" onclick="confirmImport()" class="btn btn-primary">
                    Import {{ ok_count }} {% if ok_count == 1 %}Item{% else %}Items{% endif %}
                </button>
            </div>
        {% else %}
            <a href="{{ back_url }}" class="btn btn-secondary">Go Back</a>
        {% endif %}
    </div>

    {# Table #}
    {% if !items.is_empty() %}
    {% call ui::card(class="", overflow="overflow-hidden") %}
        <table class="w-full">
            <thead>
                <tr class="border-b border-neutral-200 dark:border-neutral-700 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                    {% for col in columns %}
                        <th class="px-4 py-3">{{ col }}</th>
                    {% endfor %}
                    <th class="px-4 py-3">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
                {% for item in items %}
                <tr class="{% if item.is_skipped() %}bg-amber-50 dark:bg-amber-900/10{% else %}hover:bg-neutral-50 dark:hover:bg-neutral-700/50{% endif %}">
                    {% for cell in item.cells %}
                        <td class="px-4 py-3 text-sm {% if item.is_skipped() %}text-neutral-500 dark:text-neutral-400{% else %}text-neutral-900 dark:text-white{% endif %}">
                            {{ cell }}
                        </td>
                    {% endfor %}
                    <td class="px-4 py-3 text-sm whitespace-nowrap">
                        {% if item.is_skipped() %}
                            <span class="text-amber-600 dark:text-amber-400">{{ item.reason }}</span>
                        {% else %}
                            <span class="text-green-600 dark:text-green-400">Ready</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endcall %}
    {% endif %}

    {# Bottom actions #}
    {% if ok_count > 0 %}
    <div class="flex justify-end gap-3">
        <a href="{{ back_url }}" class="btn btn-secondary">Cancel</a>
        <button type="button" onclick="confirmImport()" class="btn btn-primary">
            Import {{ ok_count }} {% if ok_count == 1 %}Item{% else %}Items{% endif %}
        </button>
    </div>
    {% endif %}
{% endcall %}

<textarea id="import-raw-json" class="hidden">{{ raw_json }}</textarea>
{% endblock %}

{% block scripts %}
<script>
async function confirmImport() {
    var btns = document.querySelectorAll('button[onclick="confirmImport()"]');
    for (var b of btns) {
        b.disabled = true;
        b.textContent = 'Importing\u2026';
    }
    try {
        var json = document.getElementById('import-raw-json').value;
        var headers = { 'Content-Type': 'application/json' };
        var meta = document.querySelector('meta[name="xsrf-token"]');
        if (meta) headers['X-XSRF-Token'] = meta.getAttribute('content');
        var response = await fetch('{{ import_url }}', {
            method: 'POST',
            headers: headers,
            body: json
        });
        var result = await response.json();
        if (result.imported > 0) {
            if (typeof showToast === 'function') {
                showToast(result.message, { type: 'success' });
            }
            window.location.href = '{{ back_url }}';
        } else {
            if (typeof showToast === 'function') {
                showToast(result.message || 'Import failed', { type: 'error' });
            }
            for (var b of btns) {
                b.disabled = false;
                b.textContent = 'Retry';
            }
        }
    } catch (e) {
        if (typeof showToast === 'function') {
            showToast('Import failed: ' + e.message, { type: 'error' });
        }
        for (var b of btns) {
            b.disabled = false;
            b.textContent = 'Retry';
        }
    }
}
</script>
{% endblock %}
