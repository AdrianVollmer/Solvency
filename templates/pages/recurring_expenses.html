{% extends "base.html" %}
{% import "macros/ui.html" as ui %}

{% macro expense_table(rows, table_id) %}
<div class="overflow-x-auto">
    <table id="{{ table_id }}" class="w-full text-sm sortable-table">
        <thead>
            <tr class="border-b border-neutral-200 dark:border-neutral-700 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                <th class="px-6 py-3 cursor-pointer select-none" data-sort-col="0" data-sort-type="text">
                    <span class="inline-flex items-center gap-1">Description <span class="sort-indicator text-neutral-300 dark:text-neutral-600"></span></span>
                </th>
                <th class="px-6 py-3 cursor-pointer select-none" data-sort-col="1" data-sort-type="num">
                    <span class="inline-flex items-center gap-1">Frequency <span class="sort-indicator text-neutral-300 dark:text-neutral-600"></span></span>
                </th>
                <th class="px-6 py-3 text-right cursor-pointer select-none" data-sort-col="2" data-sort-type="num">
                    <span class="inline-flex items-center gap-1 justify-end">Typical Amount <span class="sort-indicator text-neutral-300 dark:text-neutral-600"></span></span>
                </th>
                <th class="px-6 py-3 cursor-pointer select-none" data-sort-col="3" data-sort-type="text">
                    <span class="inline-flex items-center gap-1">Last Seen <span class="sort-indicator text-neutral-300 dark:text-neutral-600"></span></span>
                </th>
                <th class="px-6 py-3 text-right cursor-pointer select-none" data-sort-col="4" data-sort-type="num">
                    <span class="inline-flex items-center gap-1 justify-end">Est. Annual Cost <span class="sort-indicator text-neutral-300 dark:text-neutral-600"></span></span>
                </th>
                <th class="px-6 py-3 text-right cursor-pointer select-none" data-sort-col="5" data-sort-type="num">
                    <span class="inline-flex items-center gap-1 justify-end">Total Spent <span class="sort-indicator text-neutral-300 dark:text-neutral-600"></span></span>
                </th>
                <th class="px-6 py-3 text-right cursor-pointer select-none" data-sort-col="6" data-sort-type="num">
                    <span class="inline-flex items-center gap-1 justify-end">Count <span class="sort-indicator text-neutral-300 dark:text-neutral-600"></span></span>
                </th>
            </tr>
        </thead>
        <tbody class="divide-y divide-neutral-100 dark:divide-neutral-700/50">
            {% for expense in rows %}
            <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-700/50 transition-colors{% if expense.inactive %} opacity-60{% endif %}">
                <td class="px-6 py-4" data-sort-value="{{ expense.description|lower }}">
                    <div class="flex items-center gap-2">
                        <span class="icon-sm text-neutral-400 dark:text-neutral-500 shrink-0" aria-hidden="true">{{ icons.get("repeat")|safe }}</span>
                        <span class="font-medium text-neutral-900 dark:text-white truncate max-w-xs" title="{{ expense.description }}">{{ expense.description }}</span>
                    </div>
                </td>
                <td class="px-6 py-4" data-sort-value="{{ expense.frequency_sort }}">
                    {% if expense.frequency_label == "Weekly" %}
                    <span class="inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">{{ expense.frequency_label }}</span>
                    {% else if expense.frequency_label == "Monthly" %}
                    <span class="inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">{{ expense.frequency_label }}</span>
                    {% else if expense.frequency_label == "Quarterly" %}
                    <span class="inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300">{{ expense.frequency_label }}</span>
                    {% else %}
                    <span class="inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300">{{ expense.frequency_label }}</span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 text-right text-neutral-900 dark:text-white tabular-nums" data-sort-value="{{ expense.typical_amount_cents }}">{{ expense.typical_amount_formatted }}</td>
                <td class="px-6 py-4 text-neutral-600 dark:text-neutral-400 tabular-nums" data-sort-value="{{ expense.last_date }}">{{ expense.last_date }}</td>
                <td class="px-6 py-4 text-right font-medium text-neutral-900 dark:text-white tabular-nums" data-sort-value="{{ expense.annual_cost_cents }}">{{ expense.annual_cost_formatted }}</td>
                <td class="px-6 py-4 text-right text-neutral-600 dark:text-neutral-400 tabular-nums" data-sort-value="{{ expense.total_spent_cents }}">{{ expense.total_spent_formatted }}</td>
                <td class="px-6 py-4 text-right text-neutral-600 dark:text-neutral-400 tabular-nums" data-sort-value="{{ expense.occurrence_count }}">{{ expense.occurrence_count }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endmacro %}

{% block content %}
<div class="space-y-6">
    {% call ui::page_header(title="Recurring Expenses", subtitle="Detected subscriptions and recurring charges") %}{% endcall %}

    {% if expenses.is_empty() && inactive_expenses.is_empty() %}
        {% call ui::empty_state_desc(icon="repeat", title="No recurring expenses detected", description="Once you have enough transaction history, recurring charges will appear here automatically.") %}{% endcall %}
    {% else %}

    {% if !expenses.is_empty() %}
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        {% call ui::stat_card(label="Active Subscriptions", value=subscription_count) %}{% endcall %}
        {% call ui::stat_card(label="Est. Monthly Cost", value=total_monthly_cost_formatted) %}{% endcall %}
        {% call ui::stat_card(label="Est. Annual Cost", value=total_annual_cost_formatted) %}{% endcall %}
    </div>

    {% call ui::card(class="", overflow="overflow-hidden") %}
        {% call expense_table(rows=expenses, table_id="active-table") %}{% endcall %}
    {% endcall %}
    {% endif %}

    {% if !inactive_expenses.is_empty() %}
    {% call ui::section(title="Inactive", card_class="overflow-hidden") %}
        {% call expense_table(rows=inactive_expenses, table_id="inactive-table") %}{% endcall %}
    {% endcall %}
    {% endif %}

    {% endif %}
</div>

<script>
(function() {
    for (const table of document.querySelectorAll(".sortable-table")) {
        const headers = table.querySelectorAll("th[data-sort-col]");
        let currentCol = -1;
        let ascending = true;

        for (const th of headers) {
            th.addEventListener("click", function() {
                const col = parseInt(this.dataset.sortCol);
                const type = this.dataset.sortType;
                const tbody = table.querySelector("tbody");
                const rows = Array.from(tbody.querySelectorAll("tr"));

                if (col === currentCol) {
                    ascending = !ascending;
                } else {
                    currentCol = col;
                    ascending = true;
                }

                rows.sort(function(a, b) {
                    const aVal = a.children[col].dataset.sortValue;
                    const bVal = b.children[col].dataset.sortValue;
                    let cmp;
                    if (type === "num") {
                        cmp = parseFloat(aVal) - parseFloat(bVal);
                    } else {
                        cmp = aVal.localeCompare(bVal);
                    }
                    return ascending ? cmp : -cmp;
                });

                for (const row of rows) {
                    tbody.appendChild(row);
                }

                // Update indicators
                for (const h of headers) {
                    h.querySelector(".sort-indicator").textContent = "";
                }
                this.querySelector(".sort-indicator").textContent = ascending ? "\u25B2" : "\u25BC";
            });
        }
    }
})();
</script>
{% endblock %}
