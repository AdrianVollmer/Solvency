{% extends "base.html" %}
{% import "macros/ui.html" as ui %}

{% block head %}
<style>
    .tree-node {
        position: relative;
    }
    .tree-children {
        margin-left: 1.5rem;
        padding-left: 1rem;
        border-left: 2px solid transparent;
        min-height: 4px;
    }
    .tree-children:not(:empty) {
        border-left-color: #e7e5e4;
    }
    .dark .tree-children:not(:empty) {
        border-left-color: #44403c;
    }
    .category-row {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        transition: background-color 0.15s;
    }
    .category-row:hover {
        background-color: rgb(245 245 244);
    }
    .dark .category-row:hover {
        background-color: rgb(68 64 60 / 0.5);
    }
    .sortable-ghost {
        opacity: 0.4;
    }
    .sortable-drag {
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 0.5rem;
    }
    .dark .sortable-drag {
        background: #292524;
    }
    .drop-zone-active {
        background-color: rgb(224 231 255) !important;
    }
    .dark .drop-zone-active {
        background-color: rgb(49 46 129 / 0.3) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
        {% call ui::page_header(title="Categories", subtitle="Organize your transactions") %}{% endcall %}
        {% call ui::page_action_bar(
            export_url="/categories/export",
            import_url="/categories/import",
            delete_endpoint="/categories/delete-all",
            delete_confirm="Are you sure you want to delete ALL categories? This cannot be undone.",
            add_url="/categories/new",
            add_label="Add Category",
            delete_count=delete_count
        ) %}{% endcall %}
    </div>

    {% call ui::card(class="") %}
        <div id="categories-tree" class="p-4">
            {# Tree is built by JavaScript #}
        </div>
        <div id="empty-state" class="px-6 py-12 text-center text-neutral-500 dark:text-neutral-400 hidden">
            <span class="icon-xl mx-auto mb-4 text-neutral-300 dark:text-neutral-600" aria-hidden="true">{{ icons.get("folder")|safe }}</span>
            <p class="font-medium">No categories yet</p>
            <p class="text-sm mt-1">Create one to get started</p>
        </div>
    {% endcall %}
</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/dist/{{ manifest.get("categories.js") }}" defer></script>
<script type="application/json" id="categories-data">
[{% for cat in categories %}{"id":{{ cat.category.id }},"name":"{{ cat.category.name }}","parentId":{% match cat.category.parent_id %}{% when Some with (id) %}{{ id }}{% when None %}null{% endmatch %},"color":"{{ cat.category.color }}","icon":"{{ cat.category.icon }}"}{% if !loop.last %},{% endif %}{% endfor %}]
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataEl = document.getElementById('categories-data');
    if (dataEl && window.categoriesPage) {
        const categories = JSON.parse(dataEl.textContent);
        window.categoriesPage.init(categories);
    }
});
</script>
{% endblock %}
