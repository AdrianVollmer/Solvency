{% extends "base.html" %}

{% block head %}
<style>
    .lucide-icon {
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none;
    }
    .tree-node {
        position: relative;
    }
    .tree-children {
        margin-left: 1.5rem;
        padding-left: 1rem;
        border-left: 2px solid transparent;
        min-height: 4px; /* Allow dropping into empty containers */
    }
    .tree-children:not(:empty) {
        border-left-color: #e5e7eb;
    }
    .dark .tree-children:not(:empty) {
        border-left-color: #4b5563;
    }
    .category-row {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        transition: background-color 0.15s;
    }
    .category-row:hover {
        background-color: rgb(243 244 246);
    }
    .dark .category-row:hover {
        background-color: rgb(55 65 81 / 0.5);
    }
    .sortable-ghost {
        opacity: 0.4;
    }
    .sortable-drag {
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 0.5rem;
    }
    .dark .sortable-drag {
        background: #1f2937;
    }
    .drop-zone-active {
        background-color: rgb(219 234 254) !important;
    }
    .dark .drop-zone-active {
        background-color: rgb(30 58 138 / 0.3) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Categories</h1>
        <button onclick="openAddModal()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2">
            <svg class="w-5 h-5 lucide-icon" viewBox="0 0 24 24"><use href="#plus"/></svg>
            Add Category
        </button>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
        <div id="categories-tree" class="p-4">
            <!-- Tree is built by JavaScript -->
        </div>
        <div id="empty-state" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400 hidden">
            <svg class="w-12 h-12 mx-auto mb-4 opacity-50 lucide-icon" viewBox="0 0 24 24"><use href="#folder"/></svg>
            <p>No categories yet. Create one to get started.</p>
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="category-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" onclick="closeModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md pointer-events-auto">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 id="modal-title" class="text-lg font-semibold">Add Category</h2>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    <svg class="w-5 h-5 lucide-icon" viewBox="0 0 24 24"><use href="#x"/></svg>
                </button>
            </div>
            <form id="category-form" class="p-6 space-y-4">
                <input type="hidden" id="category-id" name="id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
                    <input type="text" id="category-name" name="name" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Parent Category</label>
                    <select id="category-parent" name="parent_id"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="">None (Root Level)</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Color</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="category-color" name="color" value="#6b7280"
                                class="h-10 w-14 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                            <input type="text" id="category-color-text" value="#6b7280"
                                class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm font-mono"
                                onchange="document.getElementById('category-color').value = this.value">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Icon</label>
                        <button type="button" id="icon-picker-btn" onclick="toggleIconPicker()"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 flex items-center gap-2">
                            <svg id="selected-icon" class="w-5 h-5 lucide-icon" viewBox="0 0 24 24"><use href="#folder"/></svg>
                            <span id="selected-icon-name" class="text-sm">folder</span>
                        </button>
                        <input type="hidden" id="category-icon" name="icon" value="folder">
                    </div>
                </div>
                <div id="icon-picker" class="hidden mt-2 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                    <div class="p-2 border-b border-gray-200 dark:border-gray-700">
                        <input type="text" id="icon-search" placeholder="Search icons..."
                            class="w-full px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 focus:ring-1 focus:ring-primary-500 focus:border-primary-500"
                            oninput="filterIcons(this.value)">
                    </div>
                    <div class="p-2 max-h-36 overflow-y-auto">
                        <div class="flex flex-wrap gap-1" id="icon-grid"></div>
                        <p id="no-icons-msg" class="hidden text-sm text-gray-500 dark:text-gray-400 text-center py-2">No icons found</p>
                    </div>
                </div>
            </form>
            <div class="flex justify-end gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    Cancel
                </button>
                <button type="button" onclick="saveCategory()"
                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const CATEGORY_ICONS = [
    'folder', 'house', 'car', 'utensils', 'shopping-cart', 'shopping-bag',
    'heart', 'zap', 'film', 'music', 'gamepad-2', 'plane', 'train-front', 'bus',
    'fuel', 'parking-meter', 'gift', 'coffee', 'pizza', 'apple', 'beer',
    'wine', 'pill', 'stethoscope', 'graduation-cap', 'book', 'briefcase',
    'building', 'landmark', 'banknote', 'credit-card', 'wallet', 'piggy-bank',
    'receipt', 'calculator', 'percent', 'tag', 'tags', 'scissors', 'shirt',
    'smartphone', 'tv', 'monitor', 'laptop', 'headphones', 'camera',
    'wrench', 'hammer', 'paintbrush', 'brush', 'baby', 'dog', 'cat',
    'tree-deciduous', 'flower', 'sun', 'cloud', 'umbrella', 'sparkles', 'star',
    'ellipsis', 'circle', 'square', 'triangle', 'hexagon'
];

// Category data from server (names are HTML-escaped by Askama)
let categories = [
    {% for cat in categories %}
    { id: {{ cat.category.id }}, name: "{{ cat.category.name }}", parentId: {% match cat.category.parent_id %}{% when Some with (id) %}{{ id }}{% when None %}null{% endmatch %}, color: "{{ cat.category.color }}", icon: "{{ cat.category.icon }}" },
    {% endfor %}
];

// Decode HTML entities for plain text usage (API calls, form values)
function decodeHtml(html) {
    const txt = document.createElement('textarea');
    txt.innerHTML = html;
    return txt.value;
}

let editingId = null;
let sortableInstances = [];

document.addEventListener('DOMContentLoaded', function() {
    renderTree();
    initIconPicker();
    document.getElementById('category-color').addEventListener('input', function() {
        document.getElementById('category-color-text').value = this.value;
    });
});

// Build tree structure from flat array
function buildTree(items, parentId = null) {
    return items
        .filter(item => item.parentId === parentId)
        .map(item => ({
            ...item,
            children: buildTree(items, item.id)
        }));
}

// Render the entire tree
function renderTree() {
    const container = document.getElementById('categories-tree');
    const emptyState = document.getElementById('empty-state');

    // Destroy existing sortable instances
    for (const instance of sortableInstances) {
        instance.destroy();
    }
    sortableInstances = [];

    if (categories.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
    }

    emptyState.classList.add('hidden');
    const tree = buildTree(categories);
    container.innerHTML = renderNodes(tree);

    initSortable();
    updateParentSelect();
}

// Render nodes recursively
function renderNodes(nodes) {
    if (nodes.length === 0) return '';

    let html = '';
    for (const node of nodes) {
        // Note: node.name is already HTML-escaped by Askama, safe for innerHTML
        // But for JS string context (onclick), we need to escape quotes
        const nameForJs = node.name.replace(/'/g, "\\'");
        html += `
            <div class="tree-node" data-id="${node.id}">
                <div class="category-row group">
                    <div class="drag-handle cursor-grab active:cursor-grabbing p-1 mr-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 touch-none">
                        <svg class="w-4 h-4 lucide-icon" viewBox="0 0 24 24"><use href="#grip-vertical"/></svg>
                    </div>
                    <div class="flex items-center gap-3 flex-1 min-w-0 cursor-pointer" onclick="openEditModal(${node.id})">
                        <span class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" style="background-color: ${node.color}20; color: ${node.color};">
                            <svg class="w-5 h-5 lucide-icon" viewBox="0 0 24 24"><use href="#${node.icon}"/></svg>
                        </span>
                        <span class="font-medium text-gray-900 dark:text-gray-100">${node.name}</span>
                    </div>
                    <button onclick="event.stopPropagation(); deleteCategory(${node.id}, '${nameForJs}')"
                        class="p-2 text-gray-400 hover:text-red-600 dark:hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg class="w-5 h-5 lucide-icon" viewBox="0 0 24 24"><use href="#trash-2"/></svg>
                    </button>
                </div>
                <div class="tree-children" data-parent-id="${node.id}">
                    ${renderNodes(node.children)}
                </div>
            </div>
        `;
    }
    return html;
}

// Initialize SortableJS on all containers
function initSortable() {
    const containers = document.querySelectorAll('#categories-tree, .tree-children');

    for (const container of containers) {
        const instance = new Sortable(container, {
            group: 'categories',
            handle: '.drag-handle',
            animation: 150,
            fallbackOnBody: true,
            swapThreshold: 0.65,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            delay: 150,
            delayOnTouchOnly: true,
            touchStartThreshold: 5,
            onEnd: handleDragEnd
        });
        sortableInstances.push(instance);
    }
}

// Handle drag end - update parent
async function handleDragEnd(evt) {
    const itemEl = evt.item;
    const id = parseInt(itemEl.dataset.id);
    const newContainer = evt.to;

    // Determine new parent
    let newParentId = null;
    if (newContainer.classList.contains('tree-children')) {
        newParentId = parseInt(newContainer.dataset.parentId);
    }

    // Find category and check if parent changed
    const cat = categories.find(c => c.id === id);
    if (!cat) return;

    const oldParentId = cat.parentId;
    if (oldParentId !== newParentId) {
        // Update local state optimistically
        cat.parentId = newParentId;

        // Persist to server
        const success = await updateCategoryParent(id, newParentId);
        if (!success) {
            // Revert local state on failure
            cat.parentId = oldParentId;
            // Re-render to show correct state
            renderTree();
        }
    }
}

// Update parent select dropdown
function updateParentSelect() {
    const select = document.getElementById('category-parent');
    const currentId = editingId;

    // Build options with indentation showing hierarchy
    let options = '<option value="">None (Root Level)</option>';

    function addOptions(nodes, depth = 0) {
        for (const node of nodes) {
            // Skip the category being edited and its descendants
            if (node.id === currentId) continue;

            const indent = '\u00A0\u00A0'.repeat(depth);
            const prefix = depth > 0 ? 'â”” ' : '';
            // node.name is already HTML-escaped by Askama
            options += `<option value="${node.id}">${indent}${prefix}${node.name}</option>`;
            addOptions(node.children, depth + 1);
        }
    }

    const tree = buildTree(categories);
    addOptions(tree);
    select.innerHTML = options;
}

// Icon picker
function initIconPicker() {
    const grid = document.getElementById('icon-grid');
    if (!grid) return;

    for (const icon of CATEGORY_ICONS) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.dataset.icon = icon;
        btn.className = 'icon-btn w-9 h-9 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors';
        btn.title = icon;
        btn.innerHTML = `<svg class="w-5 h-5 lucide-icon" viewBox="0 0 24 24"><use href="#${icon}"/></svg>`;
        btn.onclick = () => selectIcon(icon);
        grid.appendChild(btn);
    }
}

function toggleIconPicker() {
    const picker = document.getElementById('icon-picker');
    const isHidden = picker.classList.toggle('hidden');
    if (!isHidden) {
        // Reset search when opening
        const search = document.getElementById('icon-search');
        search.value = '';
        filterIcons('');
        search.focus();
    }
}

function filterIcons(query) {
    const q = query.toLowerCase().trim();
    const buttons = document.querySelectorAll('#icon-grid .icon-btn');
    let visibleCount = 0;

    for (const btn of buttons) {
        const icon = btn.dataset.icon;
        const matches = !q || icon.includes(q);
        btn.classList.toggle('hidden', !matches);
        if (matches) visibleCount++;
    }

    document.getElementById('no-icons-msg').classList.toggle('hidden', visibleCount > 0);
}

function selectIcon(icon) {
    document.getElementById('category-icon').value = icon;
    document.getElementById('selected-icon').innerHTML = `<use href="#${icon}"/>`;
    document.getElementById('selected-icon-name').textContent = icon;
    document.getElementById('icon-picker').classList.add('hidden');
}

// Modal functions
function openAddModal() {
    editingId = null;
    document.getElementById('modal-title').textContent = 'Add Category';
    document.getElementById('category-form').reset();
    document.getElementById('category-id').value = '';
    document.getElementById('category-color').value = '#6b7280';
    document.getElementById('category-color-text').value = '#6b7280';
    selectIcon('folder');
    updateParentSelect();
    document.getElementById('category-modal').classList.remove('hidden');
}

function openEditModal(id) {
    const cat = categories.find(c => c.id === id);
    if (!cat) return;

    editingId = id;
    document.getElementById('modal-title').textContent = 'Edit Category';
    document.getElementById('category-id').value = id;
    document.getElementById('category-name').value = decodeHtml(cat.name);
    document.getElementById('category-color').value = cat.color;
    document.getElementById('category-color-text').value = cat.color;
    selectIcon(cat.icon);
    updateParentSelect();
    document.getElementById('category-parent').value = cat.parentId || '';
    document.getElementById('category-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('category-modal').classList.add('hidden');
    document.getElementById('icon-picker').classList.add('hidden');
}

// API functions
async function saveCategory() {
    const name = document.getElementById('category-name').value.trim();
    if (!name) return;

    const parentId = document.getElementById('category-parent').value || null;
    const color = document.getElementById('category-color').value;
    const icon = document.getElementById('category-icon').value;

    const params = new URLSearchParams();
    params.append('name', name);
    if (parentId) params.append('parent_id', parentId);
    params.append('color', color);
    params.append('icon', icon);

    try {
        let response;
        if (editingId) {
            response = await fetch(`/categories/${editingId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });
        } else {
            response = await fetch('/categories/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });
        }

        if (response.ok) {
            // Reload to get updated data
            window.location.reload();
        } else {
            alert('Failed to save category');
        }
    } catch (e) {
        alert('Error saving category: ' + e.message);
    }
}

async function deleteCategory(id, name) {
    if (!confirm(`Delete "${name}"? This will also delete all subcategories.`)) return;

    try {
        const response = await fetch(`/categories/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // Remove from local data and re-render
            removeCategory(id);
            renderTree();
        } else {
            alert('Failed to delete category');
        }
    } catch (e) {
        alert('Error deleting category: ' + e.message);
    }
}

function removeCategory(id) {
    // Remove this category and all descendants
    const toRemove = new Set([id]);
    let changed = true;
    while (changed) {
        changed = false;
        for (const cat of categories) {
            if (cat.parentId !== null && toRemove.has(cat.parentId) && !toRemove.has(cat.id)) {
                toRemove.add(cat.id);
                changed = true;
            }
        }
    }
    categories = categories.filter(c => !toRemove.has(c.id));
}

async function updateCategoryParent(id, parentId) {
    const cat = categories.find(c => c.id === id);
    if (!cat) return false;

    const params = new URLSearchParams();
    params.append('name', decodeHtml(cat.name));
    if (parentId !== null) params.append('parent_id', parentId);
    params.append('color', cat.color);
    params.append('icon', cat.icon);

    try {
        const response = await fetch(`/categories/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });
        if (!response.ok) {
            console.error('Failed to update category:', response.status);
            return false;
        }
        return true;
    } catch (e) {
        console.error('Error updating category:', e);
        return false;
    }
}
</script>
{% endblock %}
