{% extends "base.html" %}
{% import "macros/ui.html" as ui %}

{% block head %}
<style>
    .tree-node {
        position: relative;
    }
    .tree-children {
        margin-left: 1.5rem;
        padding-left: 1rem;
        border-left: 2px solid transparent;
        min-height: 4px;
    }
    .tree-children:not(:empty) {
        border-left-color: #e7e5e4;
    }
    .dark .tree-children:not(:empty) {
        border-left-color: #44403c;
    }
    .category-row {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        transition: background-color 0.15s;
    }
    .category-row:hover {
        background-color: rgb(245 245 244);
    }
    .dark .category-row:hover {
        background-color: rgb(68 64 60 / 0.5);
    }
    .sortable-ghost {
        opacity: 0.4;
    }
    .sortable-drag {
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 0.5rem;
    }
    .dark .sortable-drag {
        background: #292524;
    }
    .drop-zone-active {
        background-color: rgb(224 231 255) !important;
    }
    .dark .drop-zone-active {
        background-color: rgb(49 46 129 / 0.3) !important;
    }
</style>
{% endblock %}

{% block content %}
{# SVG sprite sheet for category icons - used by JavaScript icon picker #}
<svg class="hidden">
  {{ icons.symbol("folder")|safe }}
  {{ icons.symbol("house")|safe }}
  {{ icons.symbol("car")|safe }}
  {{ icons.symbol("utensils")|safe }}
  {{ icons.symbol("shopping-cart")|safe }}
  {{ icons.symbol("shopping-bag")|safe }}
  {{ icons.symbol("heart")|safe }}
  {{ icons.symbol("zap")|safe }}
  {{ icons.symbol("film")|safe }}
  {{ icons.symbol("music")|safe }}
  {{ icons.symbol("gamepad-2")|safe }}
  {{ icons.symbol("plane")|safe }}
  {{ icons.symbol("train-front")|safe }}
  {{ icons.symbol("bus")|safe }}
  {{ icons.symbol("fuel")|safe }}
  {{ icons.symbol("parking-meter")|safe }}
  {{ icons.symbol("gift")|safe }}
  {{ icons.symbol("coffee")|safe }}
  {{ icons.symbol("pizza")|safe }}
  {{ icons.symbol("apple")|safe }}
  {{ icons.symbol("beer")|safe }}
  {{ icons.symbol("wine")|safe }}
  {{ icons.symbol("pill")|safe }}
  {{ icons.symbol("stethoscope")|safe }}
  {{ icons.symbol("graduation-cap")|safe }}
  {{ icons.symbol("book")|safe }}
  {{ icons.symbol("briefcase")|safe }}
  {{ icons.symbol("building")|safe }}
  {{ icons.symbol("landmark")|safe }}
  {{ icons.symbol("banknote")|safe }}
  {{ icons.symbol("credit-card")|safe }}
  {{ icons.symbol("wallet")|safe }}
  {{ icons.symbol("piggy-bank")|safe }}
  {{ icons.symbol("receipt")|safe }}
  {{ icons.symbol("calculator")|safe }}
  {{ icons.symbol("percent")|safe }}
  {{ icons.symbol("tag")|safe }}
  {{ icons.symbol("tags")|safe }}
  {{ icons.symbol("scissors")|safe }}
  {{ icons.symbol("shirt")|safe }}
  {{ icons.symbol("smartphone")|safe }}
  {{ icons.symbol("tv")|safe }}
  {{ icons.symbol("monitor")|safe }}
  {{ icons.symbol("laptop")|safe }}
  {{ icons.symbol("headphones")|safe }}
  {{ icons.symbol("camera")|safe }}
  {{ icons.symbol("wrench")|safe }}
  {{ icons.symbol("hammer")|safe }}
  {{ icons.symbol("paintbrush")|safe }}
  {{ icons.symbol("brush")|safe }}
  {{ icons.symbol("baby")|safe }}
  {{ icons.symbol("dog")|safe }}
  {{ icons.symbol("cat")|safe }}
  {{ icons.symbol("tree-deciduous")|safe }}
  {{ icons.symbol("flower")|safe }}
  {{ icons.symbol("sun")|safe }}
  {{ icons.symbol("cloud")|safe }}
  {{ icons.symbol("umbrella")|safe }}
  {{ icons.symbol("sparkles")|safe }}
  {{ icons.symbol("star")|safe }}
  {{ icons.symbol("ellipsis")|safe }}
  {{ icons.symbol("circle")|safe }}
  {{ icons.symbol("square")|safe }}
  {{ icons.symbol("triangle")|safe }}
  {{ icons.symbol("hexagon")|safe }}
  {{ icons.symbol("grip-vertical")|safe }}
  {{ icons.symbol("trash-2")|safe }}
</svg>
<div class="space-y-6">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
        {% call ui::page_header(title="Categories", subtitle="Organize your transactions") %}{% endcall %}
        {% call ui::page_action_bar(
            export_url="/categories/export",
            import_url="/categories/import",
            delete_endpoint="/categories/delete-all",
            delete_confirm="Are you sure you want to delete ALL categories? This cannot be undone.",
            add_url="/categories/new",
            add_label="Add Category",
            delete_count=delete_count
        ) %}{% endcall %}
    </div>

    {% call ui::card(class="") %}
        <div id="categories-tree" class="p-4">
            {# Tree is built by JavaScript #}
        </div>
        <div id="empty-state" class="px-6 py-12 text-center text-neutral-500 dark:text-neutral-400 hidden">
            <span class="icon-xl mx-auto mb-4 text-neutral-300 dark:text-neutral-600" aria-hidden="true">{{ icons.get("folder")|safe }}</span>
            <p class="font-medium">No categories yet</p>
            <p class="text-sm mt-1">Create one to get started</p>
        </div>
    {% endcall %}
</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/dist/{{ manifest.get("categories.js") }}" defer></script>
<script type="application/json" id="categories-data">
[{% for cat in categories %}{"id":{{ cat.category.id }},"name":"{{ cat.category.name }}","parentId":{% match cat.category.parent_id %}{% when Some with (id) %}{{ id }}{% when None %}null{% endmatch %},"color":"{{ cat.category.color }}","icon":"{{ cat.category.icon }}"}{% if !loop.last %},{% endif %}{% endfor %}]
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataEl = document.getElementById('categories-data');
    if (dataEl && window.categoriesPage) {
        const categories = JSON.parse(dataEl.textContent);
        window.categoriesPage.init(categories);
    }
});
</script>
{% endblock %}
