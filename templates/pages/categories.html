{% extends "base.html" %}

{% block head %}
<style>
    /* Ensure Lucide icons inherit color via stroke */
    .lucide-icon {
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none;
    }
    /* Tree structure styling */
    .tree-children {
        position: relative;
        margin-left: 1.25rem;
        padding-left: 1.25rem;
    }
    .tree-children::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0.75rem;
        width: 2px;
        background-color: #e5e7eb;
    }
    .dark .tree-children::before {
        background-color: #4b5563;
    }
    .tree-children .category-item::before {
        content: '';
        position: absolute;
        left: -1.25rem;
        top: 1.25rem;
        width: 1rem;
        height: 2px;
        background-color: #e5e7eb;
    }
    .dark .tree-children .category-item::before {
        background-color: #4b5563;
    }
    .tree-children .category-item {
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Categories</h1>
        <button onclick="openAddModal()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2">
            <svg class="w-5 h-5 lucide-icon"><use href="#plus"/></svg>
            Add Category
        </button>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div id="categories-tree" class="p-4 space-y-1">
            {% for category in categories %}
            {% if category.depth == 0 %}
            <div class="category-item" data-id="{{ category.category.id }}" data-parent="" data-depth="0">
                <div class="flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 group transition-colors">
                    <div class="drag-handle cursor-grab active:cursor-grabbing p-1 mr-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 touch-none">
                        <svg class="w-5 h-5 lucide-icon"><use href="#grip-vertical"/></svg>
                    </div>
                    <div class="flex items-center gap-3 flex-1 min-w-0 cursor-pointer" onclick="openEditModal({{ category.category.id }})">
                        <span class="w-9 h-9 rounded-lg flex items-center justify-center flex-shrink-0" style="background-color: {{ category.category.color }}20; color: {{ category.category.color }};">
                            <svg class="w-5 h-5 lucide-icon"><use href="#{{ category.category.icon }}"/></svg>
                        </span>
                        <span class="font-medium">{{ category.category.name }}</span>
                    </div>
                    <button onclick="event.stopPropagation(); deleteCategory({{ category.category.id }}, '{{ category.category.name }}')"
                        class="p-2 text-gray-400 hover:text-red-600 dark:hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg class="w-5 h-5 lucide-icon"><use href="#trash-2"/></svg>
                    </button>
                </div>
                <!-- Children with tree lines -->
                <div class="tree-children" data-parent-id="{{ category.category.id }}">
                    {% for child in categories %}
                    {% if child.is_child_of(category.category.id) %}
                    <div class="category-item" data-id="{{ child.category.id }}" data-parent="{{ child.parent_id_or_empty() }}" data-depth="1">
                        <div class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 group transition-colors">
                            <div class="drag-handle cursor-grab active:cursor-grabbing p-1 mr-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 touch-none">
                                <svg class="w-4 h-4 lucide-icon"><use href="#grip-vertical"/></svg>
                            </div>
                            <div class="flex items-center gap-2.5 flex-1 min-w-0 cursor-pointer" onclick="openEditModal({{ child.category.id }})">
                                <span class="w-7 h-7 rounded-md flex items-center justify-center flex-shrink-0" style="background-color: {{ child.category.color }}20; color: {{ child.category.color }};">
                                    <svg class="w-4 h-4 lucide-icon"><use href="#{{ child.category.icon }}"/></svg>
                                </span>
                                <span class="text-sm text-gray-700 dark:text-gray-300">{{ child.category.name }}</span>
                            </div>
                            <button onclick="event.stopPropagation(); deleteCategory({{ child.category.id }}, '{{ child.category.name }}')"
                                class="p-1.5 text-gray-400 hover:text-red-600 dark:hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg class="w-4 h-4 lucide-icon"><use href="#trash-2"/></svg>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        {% if categories.is_empty() %}
        <div class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
            <svg class="w-12 h-12 mx-auto mb-4 opacity-50 lucide-icon"><use href="#folder"/></svg>
            <p>No categories yet. Create one to get started.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="category-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" onclick="closeModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md pointer-events-auto">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 id="modal-title" class="text-lg font-semibold">Add Category</h2>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    <svg class="w-5 h-5 lucide-icon"><use href="#x"/></svg>
                </button>
            </div>
            <form id="category-form" class="p-6 space-y-4">
                <input type="hidden" id="category-id" name="id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
                    <input type="text" id="category-name" name="name" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Parent Category</label>
                    <select id="category-parent" name="parent_id"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="">No Parent (Top Level)</option>
                        {% for cat in categories %}
                        {% if cat.depth == 0 %}
                        <option value="{{ cat.category.id }}">{{ cat.category.name }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Color</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="category-color" name="color" value="#6b7280"
                                class="h-10 w-14 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                            <input type="text" id="category-color-text" value="#6b7280"
                                class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm font-mono"
                                onchange="document.getElementById('category-color').value = this.value">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Icon</label>
                        <div class="relative">
                            <button type="button" id="icon-picker-btn" onclick="toggleIconPicker()"
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 flex items-center gap-2">
                                <svg id="selected-icon" class="w-5 h-5 lucide-icon"><use href="#folder"/></svg>
                                <span id="selected-icon-name" class="text-sm">folder</span>
                            </button>
                            <input type="hidden" id="category-icon" name="icon" value="folder">
                        </div>
                    </div>
                </div>
                <div id="icon-picker" class="hidden border border-gray-200 dark:border-gray-700 rounded-lg p-3 max-h-48 overflow-y-auto">
                    <div class="grid grid-cols-8 gap-1" id="icon-grid">
                    </div>
                </div>
            </form>
            <div class="flex justify-end gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    Cancel
                </button>
                <button type="button" onclick="saveCategory()"
                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const CATEGORY_ICONS = [
    'folder', 'home', 'car', 'utensils', 'shopping-cart', 'shopping-bag',
    'heart', 'zap', 'film', 'music', 'gamepad-2', 'plane', 'train', 'bus',
    'fuel', 'parking-meter', 'gift', 'coffee', 'pizza', 'apple', 'beer',
    'wine', 'pill', 'stethoscope', 'graduation-cap', 'book', 'briefcase',
    'building', 'landmark', 'banknote', 'credit-card', 'wallet', 'piggy-bank',
    'receipt', 'calculator', 'percent', 'tag', 'tags', 'scissors', 'shirt',
    'smartphone', 'tv', 'monitor', 'laptop', 'headphones', 'camera',
    'wrench', 'hammer', 'paintbrush', 'brush', 'baby', 'dog', 'cat',
    'tree', 'flower', 'sun', 'cloud', 'umbrella', 'sparkles', 'star',
    'more-horizontal', 'circle', 'square', 'triangle', 'hexagon'
];

const categories = [
    {% for cat in categories %}
    { id: {{ cat.category.id }}, name: "{{ cat.category.name }}", parentId: {% match cat.category.parent_id %}{% when Some with (id) %}{{ id }}{% when None %}null{% endmatch %}, color: "{{ cat.category.color }}", icon: "{{ cat.category.icon }}" },
    {% endfor %}
];

let editingId = null;

document.addEventListener('DOMContentLoaded', function() {
    initSortable();
    initIconPicker();

    document.getElementById('category-color').addEventListener('input', function() {
        document.getElementById('category-color-text').value = this.value;
    });
});

function initSortable() {
    const tree = document.getElementById('categories-tree');
    if (!tree) return;

    // Top-level categories
    new Sortable(tree, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'opacity-50',
        draggable: '& > .category-item',
        delay: 100,
        delayOnTouchOnly: true,
        touchStartThreshold: 3
    });

    // Children containers
    document.querySelectorAll('.tree-children').forEach(container => {
        new Sortable(container, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'opacity-50',
            group: 'nested',
            delay: 100,
            delayOnTouchOnly: true,
            touchStartThreshold: 3,
            onEnd: function(evt) {
                const item = evt.item;
                const id = item.dataset.id;
                const newParentId = evt.to.dataset.parentId;
                if (newParentId && newParentId !== item.dataset.parent) {
                    updateCategoryParent(id, newParentId);
                }
            }
        });
    });
}

function initIconPicker() {
    const grid = document.getElementById('icon-grid');
    if (!grid) return;

    CATEGORY_ICONS.forEach(icon => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors';
        btn.innerHTML = `<svg class="w-5 h-5 lucide-icon"><use href="#${icon}"/></svg>`;
        btn.onclick = () => selectIcon(icon);
        grid.appendChild(btn);
    });
}

function toggleIconPicker() {
    document.getElementById('icon-picker').classList.toggle('hidden');
}

function selectIcon(icon) {
    document.getElementById('category-icon').value = icon;
    document.getElementById('selected-icon').innerHTML = `<use href="#${icon}"/>`;
    document.getElementById('selected-icon-name').textContent = icon;
    document.getElementById('icon-picker').classList.add('hidden');
}

function openAddModal() {
    editingId = null;
    document.getElementById('modal-title').textContent = 'Add Category';
    document.getElementById('category-form').reset();
    document.getElementById('category-color').value = '#6b7280';
    document.getElementById('category-color-text').value = '#6b7280';
    selectIcon('folder');
    document.getElementById('category-modal').classList.remove('hidden');
}

function openEditModal(id) {
    const cat = categories.find(c => c.id === id);
    if (!cat) return;

    editingId = id;
    document.getElementById('modal-title').textContent = 'Edit Category';
    document.getElementById('category-id').value = id;
    document.getElementById('category-name').value = cat.name;
    document.getElementById('category-parent').value = cat.parentId || '';
    document.getElementById('category-color').value = cat.color;
    document.getElementById('category-color-text').value = cat.color;
    selectIcon(cat.icon);
    document.getElementById('category-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('category-modal').classList.add('hidden');
    document.getElementById('icon-picker').classList.add('hidden');
}

async function saveCategory() {
    const name = document.getElementById('category-name').value;
    const parentId = document.getElementById('category-parent').value || '';
    const color = document.getElementById('category-color').value;
    const icon = document.getElementById('category-icon').value;

    const formData = new FormData();
    formData.append('name', name);
    if (parentId) formData.append('parent_id', parentId);
    formData.append('color', color);
    formData.append('icon', icon);

    try {
        let response;
        if (editingId) {
            response = await fetch(`/categories/${editingId}`, {
                method: 'PUT',
                body: formData
            });
        } else {
            response = await fetch('/categories/create', {
                method: 'POST',
                body: formData
            });
        }

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to save category');
        }
    } catch (e) {
        alert('Error saving category: ' + e.message);
    }
}

async function deleteCategory(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

    try {
        const response = await fetch(`/categories/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            document.querySelector(`.category-item[data-id="${id}"]`)?.remove();
        } else {
            alert('Failed to delete category');
        }
    } catch (e) {
        alert('Error deleting category: ' + e.message);
    }
}

async function updateCategoryParent(id, parentId) {
    const cat = categories.find(c => c.id == id);
    if (!cat) return;

    const formData = new FormData();
    formData.append('name', cat.name);
    if (parentId) formData.append('parent_id', parentId);
    formData.append('color', cat.color);
    formData.append('icon', cat.icon);

    try {
        await fetch(`/categories/${id}`, {
            method: 'PUT',
            body: formData
        });
    } catch (e) {
        console.error('Error updating category:', e);
    }
}
</script>
{% endblock %}
