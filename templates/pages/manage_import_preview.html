{% extends "base.html" %}
{% import "macros/ui.html" as ui %}

{% block content %}
{% call ui::page_container(max_width="max-w-4xl") %}
    {% call ui::page_header(title="Import Manage Data â€” Preview", back_url="/manage", back_label="Manage") %}{% endcall %}

    {# Summary #}
    <div class="flex items-center justify-between">
        <p class="text-sm text-neutral-600 dark:text-neutral-400">
            {% if total_ok > 0 %}
                <span class="font-semibold text-neutral-900 dark:text-white">{{ total_ok }}</span>
                {% if total_ok == 1 %}item{% else %}items{% endif %} will be imported
            {% endif %}
            {% if category_skip + tag_skip + rule_skip > 0 %}
                {% if total_ok > 0 %}, {% endif %}
                <span class="font-semibold text-amber-600 dark:text-amber-400">{{ category_skip + tag_skip + rule_skip }}</span>
                will be skipped
            {% endif %}
            {% if total_ok == 0 && category_skip + tag_skip + rule_skip == 0 %}
                No items found in file.
            {% endif %}
        </p>
        {% if total_ok > 0 %}
            <div class="flex gap-3">
                <a href="/manage" class="btn btn-secondary">Cancel</a>
                <button type="button" onclick="confirmImport()" class="btn btn-primary">
                    Import {{ total_ok }} {% if total_ok == 1 %}Item{% else %}Items{% endif %}
                </button>
            </div>
        {% else %}
            <a href="/manage" class="btn btn-secondary">Go Back</a>
        {% endif %}
    </div>

    {# Categories section #}
    {% if !category_items.is_empty() %}
    <div class="space-y-3">
        <h3 class="text-sm font-semibold text-neutral-700 dark:text-neutral-300">
            Categories
            <span class="font-normal text-neutral-500 dark:text-neutral-400">
                ({{ category_ok }} to import{% if category_skip > 0 %}, {{ category_skip }} skipped{% endif %})
            </span>
        </h3>

        {% if category_skip > 0 %}
        <details class="group">
            <summary class="text-xs font-medium text-amber-600 dark:text-amber-400 cursor-pointer">{{ category_skip }} skipped</summary>
            {% call ui::card(class="mt-2", overflow="overflow-hidden") %}
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-neutral-200 dark:border-neutral-700 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3">Parent</th>
                            <th class="px-4 py-3">Color</th>
                            <th class="px-4 py-3">Icon</th>
                            <th class="px-4 py-3">Reason</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
                        {% for item in category_items %}
                        {% if item.is_skipped() %}
                        <tr>
                            {% for cell in item.cells %}<td class="px-4 py-3 text-sm text-neutral-900 dark:text-white">{{ cell }}</td>{% endfor %}
                            <td class="px-4 py-3 text-sm text-amber-600 dark:text-amber-400 whitespace-nowrap">{{ item.reason }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            {% endcall %}
        </details>
        {% endif %}

        {% if category_ok > 0 %}
        {% call ui::card(class="", overflow="overflow-hidden") %}
            <table class="w-full">
                <thead>
                    <tr class="border-b border-neutral-200 dark:border-neutral-700 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                        <th class="px-4 py-3">Name</th>
                        <th class="px-4 py-3">Parent</th>
                        <th class="px-4 py-3">Color</th>
                        <th class="px-4 py-3">Icon</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
                    {% for item in category_items %}
                    {% if !item.is_skipped() %}
                    <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-700/50">
                        {% for cell in item.cells %}<td class="px-4 py-3 text-sm text-neutral-900 dark:text-white">{{ cell }}</td>{% endfor %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% endcall %}
        {% endif %}
    </div>
    {% endif %}

    {# Tags section #}
    {% if !tag_items.is_empty() %}
    <div class="space-y-3">
        <h3 class="text-sm font-semibold text-neutral-700 dark:text-neutral-300">
            Tags
            <span class="font-normal text-neutral-500 dark:text-neutral-400">
                ({{ tag_ok }} to import{% if tag_skip > 0 %}, {{ tag_skip }} skipped{% endif %})
            </span>
        </h3>

        {% if tag_skip > 0 %}
        <details class="group">
            <summary class="text-xs font-medium text-amber-600 dark:text-amber-400 cursor-pointer">{{ tag_skip }} skipped</summary>
            {% call ui::card(class="mt-2", overflow="overflow-hidden") %}
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-neutral-200 dark:border-neutral-700 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3">Color</th>
                            <th class="px-4 py-3">Style</th>
                            <th class="px-4 py-3">Reason</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
                        {% for item in tag_items %}
                        {% if item.is_skipped() %}
                        <tr>
                            {% for cell in item.cells %}<td class="px-4 py-3 text-sm text-neutral-900 dark:text-white">{{ cell }}</td>{% endfor %}
                            <td class="px-4 py-3 text-sm text-amber-600 dark:text-amber-400 whitespace-nowrap">{{ item.reason }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            {% endcall %}
        </details>
        {% endif %}

        {% if tag_ok > 0 %}
        {% call ui::card(class="", overflow="overflow-hidden") %}
            <table class="w-full">
                <thead>
                    <tr class="border-b border-neutral-200 dark:border-neutral-700 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                        <th class="px-4 py-3">Name</th>
                        <th class="px-4 py-3">Color</th>
                        <th class="px-4 py-3">Style</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
                    {% for item in tag_items %}
                    {% if !item.is_skipped() %}
                    <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-700/50">
                        {% for cell in item.cells %}<td class="px-4 py-3 text-sm text-neutral-900 dark:text-white">{{ cell }}</td>{% endfor %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% endcall %}
        {% endif %}
    </div>
    {% endif %}

    {# Rules section #}
    {% if !rule_items.is_empty() %}
    <div class="space-y-3">
        <h3 class="text-sm font-semibold text-neutral-700 dark:text-neutral-300">
            Rules
            <span class="font-normal text-neutral-500 dark:text-neutral-400">
                ({{ rule_ok }} to import{% if rule_skip > 0 %}, {{ rule_skip }} skipped{% endif %})
            </span>
        </h3>

        {% if rule_skip > 0 %}
        <details class="group">
            <summary class="text-xs font-medium text-amber-600 dark:text-amber-400 cursor-pointer">{{ rule_skip }} skipped</summary>
            {% call ui::card(class="mt-2", overflow="overflow-hidden") %}
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-neutral-200 dark:border-neutral-700 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3">Pattern</th>
                            <th class="px-4 py-3">Action</th>
                            <th class="px-4 py-3">Target</th>
                            <th class="px-4 py-3">Reason</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
                        {% for item in rule_items %}
                        {% if item.is_skipped() %}
                        <tr>
                            {% for cell in item.cells %}<td class="px-4 py-3 text-sm text-neutral-900 dark:text-white">{{ cell }}</td>{% endfor %}
                            <td class="px-4 py-3 text-sm text-amber-600 dark:text-amber-400 whitespace-nowrap">{{ item.reason }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            {% endcall %}
        </details>
        {% endif %}

        {% if rule_ok > 0 %}
        {% call ui::card(class="", overflow="overflow-hidden") %}
            <table class="w-full">
                <thead>
                    <tr class="border-b border-neutral-200 dark:border-neutral-700 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                        <th class="px-4 py-3">Name</th>
                        <th class="px-4 py-3">Pattern</th>
                        <th class="px-4 py-3">Action</th>
                        <th class="px-4 py-3">Target</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
                    {% for item in rule_items %}
                    {% if !item.is_skipped() %}
                    <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-700/50">
                        {% for cell in item.cells %}<td class="px-4 py-3 text-sm text-neutral-900 dark:text-white">{{ cell }}</td>{% endfor %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% endcall %}
        {% endif %}
    </div>
    {% endif %}

    {# Bottom actions #}
    {% if total_ok > 0 %}
    <div class="flex justify-end gap-3">
        <a href="/manage" class="btn btn-secondary">Cancel</a>
        <button type="button" onclick="confirmImport()" class="btn btn-primary">
            Import {{ total_ok }} {% if total_ok == 1 %}Item{% else %}Items{% endif %}
        </button>
    </div>
    {% endif %}
{% endcall %}

<textarea id="import-raw-json" class="hidden">{{ raw_json }}</textarea>
{% endblock %}

{% block scripts %}
<script>
async function confirmImport() {
    var btns = document.querySelectorAll('button[onclick="confirmImport()"]');
    for (var b of btns) {
        b.disabled = true;
        b.textContent = 'Importing\u2026';
    }
    try {
        var json = document.getElementById('import-raw-json').value;
        var headers = { 'Content-Type': 'application/json' };
        var meta = document.querySelector('meta[name="xsrf-token"]');
        if (meta) headers['X-XSRF-Token'] = meta.getAttribute('content');
        var response = await fetch('/manage/import', {
            method: 'POST',
            headers: headers,
            body: json
        });
        var result = await response.json();
        var totalImported = (result.imported.categories || 0) + (result.imported.tags || 0) + (result.imported.rules || 0);
        if (totalImported > 0) {
            if (typeof showToast === 'function') {
                showToast(result.message, { type: 'success' });
            }
            window.location.href = '/manage';
        } else {
            if (typeof showToast === 'function') {
                showToast(result.message || 'Import failed', { type: 'error' });
            }
            for (var b of btns) {
                b.disabled = false;
                b.textContent = 'Retry';
            }
        }
    } catch (e) {
        if (typeof showToast === 'function') {
            showToast('Import failed: ' + e.message, { type: 'error' });
        }
        for (var b of btns) {
            b.disabled = false;
            b.textContent = 'Retry';
        }
    }
}
</script>
{% endblock %}
