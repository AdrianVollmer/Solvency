{% extends "base.html" %}
{% import "macros/ui.html" as ui %}

{% block content %}
<div class="space-y-8">
    {% call ui::page_header(title="Settings", subtitle="Configure your preferences") %}{% endcall %}

    <form hx-post="/settings/update" hx-target="#settings-message" hx-swap="innerHTML" class="space-y-8 max-w-2xl">
        {# Appearance #}
        <section>
            <h2 class="section-title mb-4">Appearance</h2>
            <div class="bg-white dark:bg-neutral-800 rounded-xl border border-neutral-200 dark:border-neutral-700 p-6">
                <fieldset>
                    <legend class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3">Theme</legend>
                    <div class="flex gap-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="theme" value="system" {% if settings.is_theme("system") %}checked{% endif %}
                                class="w-4 h-4 text-primary-600 focus:ring-primary-500 border-neutral-300 dark:border-neutral-600">
                            <span class="text-sm">System</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="theme" value="light" {% if settings.is_theme("light") %}checked{% endif %}
                                class="w-4 h-4 text-primary-600 focus:ring-primary-500 border-neutral-300 dark:border-neutral-600">
                            <span class="text-sm">Light</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="theme" value="dark" {% if settings.is_theme("dark") %}checked{% endif %}
                                class="w-4 h-4 text-primary-600 focus:ring-primary-500 border-neutral-300 dark:border-neutral-600">
                            <span class="text-sm">Dark</span>
                        </label>
                    </div>
                </fieldset>
            </div>
        </section>

        {# Regional #}
        <section>
            <h2 class="section-title mb-4">Regional</h2>
            <div class="bg-white dark:bg-neutral-800 rounded-xl border border-neutral-200 dark:border-neutral-700 p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="currency" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">Default Currency</label>
                        <select id="currency" name="currency" class="input w-full">
                            <option value="USD" {% if settings.is_currency("USD") %}selected{% endif %}>US Dollar ($)</option>
                            <option value="EUR" {% if settings.is_currency("EUR") %}selected{% endif %}>Euro (€)</option>
                            <option value="GBP" {% if settings.is_currency("GBP") %}selected{% endif %}>British Pound (£)</option>
                            <option value="JPY" {% if settings.is_currency("JPY") %}selected{% endif %}>Japanese Yen (¥)</option>
                            <option value="CAD" {% if settings.is_currency("CAD") %}selected{% endif %}>Canadian Dollar (C$)</option>
                            <option value="AUD" {% if settings.is_currency("AUD") %}selected{% endif %}>Australian Dollar (A$)</option>
                            <option value="CHF" {% if settings.is_currency("CHF") %}selected{% endif %}>Swiss Franc (CHF)</option>
                            <option value="CNY" {% if settings.is_currency("CNY") %}selected{% endif %}>Chinese Yuan (¥)</option>
                            <option value="INR" {% if settings.is_currency("INR") %}selected{% endif %}>Indian Rupee (₹)</option>
                            <option value="BRL" {% if settings.is_currency("BRL") %}selected{% endif %}>Brazilian Real (R$)</option>
                            <option value="MXN" {% if settings.is_currency("MXN") %}selected{% endif %}>Mexican Peso (MX$)</option>
                        </select>
                    </div>

                    <div>
                        <label for="date_format" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">Date Format</label>
                        <select id="date_format" name="date_format" class="input w-full">
                            <option value="YYYY-MM-DD" {% if settings.is_date_format("YYYY-MM-DD") %}selected{% endif %}>2024-01-15</option>
                            <option value="MM/DD/YYYY" {% if settings.is_date_format("MM/DD/YYYY") %}selected{% endif %}>01/15/2024</option>
                            <option value="DD/MM/YYYY" {% if settings.is_date_format("DD/MM/YYYY") %}selected{% endif %}>15/01/2024</option>
                        </select>
                    </div>

                    <div>
                        <label for="locale" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">Locale</label>
                        <select id="locale" name="locale" class="input w-full">
                            <option value="en-US" {% if settings.is_locale("en-US") %}selected{% endif %}>English (US)</option>
                            <option value="en-GB" {% if settings.is_locale("en-GB") %}selected{% endif %}>English (UK)</option>
                            <option value="de-DE" {% if settings.is_locale("de-DE") %}selected{% endif %}>German</option>
                            <option value="fr-FR" {% if settings.is_locale("fr-FR") %}selected{% endif %}>French</option>
                            <option value="es-ES" {% if settings.is_locale("es-ES") %}selected{% endif %}>Spanish</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        {# Display #}
        <section>
            <h2 class="section-title mb-4">Display</h2>
            <div class="bg-white dark:bg-neutral-800 rounded-xl border border-neutral-200 dark:border-neutral-700 p-6">
                <div>
                    <label for="page_size" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">Items per Page</label>
                    <select id="page_size" name="page_size" class="input w-full max-w-xs">
                        <option value="10" {% if settings.page_size == 10 %}selected{% endif %}>10</option>
                        <option value="25" {% if settings.page_size == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if settings.page_size == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if settings.page_size == 100 %}selected{% endif %}>100</option>
                    </select>
                </div>
            </div>
        </section>

        <div id="settings-message"></div>

        <button type="submit" class="btn btn-primary">
            Save Settings
        </button>
    </form>

    {# Database - outside the form since it has its own actions #}
    <section class="max-w-2xl">
        <h2 class="section-title mb-4">Database</h2>
        <div class="bg-white dark:bg-neutral-800 rounded-xl border border-neutral-200 dark:border-neutral-700 p-6 space-y-6">
            <div>
                <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-1">Database Size</p>
                <p class="text-lg font-medium">{{ database_size }}</p>
            </div>

            <div class="border-t border-neutral-200 dark:border-neutral-700 pt-6">
                <h3 class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3">Export</h3>
                <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-3">Download a full backup of your database as SQL.</p>
                <a href="/settings/export-database" class="btn btn-secondary">
                    Download Backup
                </a>
            </div>

            <div class="border-t border-neutral-200 dark:border-neutral-700 pt-6">
                <h3 class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3">Import</h3>
                <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-3">
                    Restore from a SQL backup file. <strong class="text-red-600 dark:text-red-400">Warning:</strong> This will overwrite all existing data.
                </p>
                <form hx-post="/settings/import-database" hx-target="#import-message" hx-swap="innerHTML" hx-encoding="multipart/form-data">
                    <div class="flex items-center gap-4">
                        <input type="file" name="file" accept=".sql" required
                            class="text-sm text-neutral-600 dark:text-neutral-400
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-lg file:border-0
                                file:text-sm file:font-medium
                                file:bg-neutral-100 file:text-neutral-700
                                dark:file:bg-neutral-700 dark:file:text-neutral-200
                                file:cursor-pointer file:transition-colors
                                hover:file:bg-neutral-200 dark:hover:file:bg-neutral-600">
                        <button type="submit" class="btn btn-danger border border-red-700"
                            onclick="return confirm('Are you sure? This will overwrite ALL existing data.')">
                            Restore Backup
                        </button>
                    </div>
                </form>
                <div id="import-message" class="mt-4"></div>
            </div>

            <div class="border-t border-neutral-200 dark:border-neutral-700 pt-6">
                <h3 class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3">Clear Database</h3>
                <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-3">
                    Delete all data from the database. <strong class="text-red-600 dark:text-red-400">Warning:</strong> This will permanently remove all expenses, categories, accounts, and other data. The database structure will be preserved.
                </p>
                {% call ui::delete_action_reload(endpoint="/settings/clear-database", confirm="Are you sure you want to clear the ENTIRE database? All data will be permanently deleted. This cannot be undone.", label="Clear Database") %}{% endcall %}
            </div>
        </div>
    </section>
</div>
{% endblock %}
