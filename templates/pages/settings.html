{% extends "base.html" %}
{% import "macros/ui.html" as ui %}

{% block content %}
<div class="space-y-6">
    {% call ui::page_header(title="Settings", subtitle="Configure your preferences") %}{% endcall %}

    <form hx-post="/settings/update" hx-target="#settings-message" hx-swap="innerHTML" hx-disabled-elt="find button[type='submit']" class="space-y-6 max-w-2xl">
        {# Appearance #}
        {% call ui::section(title="Appearance") %}
            <fieldset>
                <legend class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3">Theme</legend>
                <div class="flex gap-6">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="theme" value="system" {% if settings.is_theme("system") %}checked{% endif %}
                            class="w-4 h-4 text-primary-600 focus:ring-primary-500 border-neutral-300 dark:border-neutral-600">
                        <span class="text-sm">System</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="theme" value="light" {% if settings.is_theme("light") %}checked{% endif %}
                            class="w-4 h-4 text-primary-600 focus:ring-primary-500 border-neutral-300 dark:border-neutral-600">
                        <span class="text-sm">Light</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="theme" value="dark" {% if settings.is_theme("dark") %}checked{% endif %}
                            class="w-4 h-4 text-primary-600 focus:ring-primary-500 border-neutral-300 dark:border-neutral-600">
                        <span class="text-sm">Dark</span>
                    </label>
                </div>
            </fieldset>
        {% endcall %}

        {# Regional #}
        {% call ui::section(title="Regional", card_class="p-6 space-y-6") %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% call ui::field(label="Default Currency", id="currency") %}
                    <select id="currency" name="currency" class="input w-full">
                        <option value="USD" {% if settings.is_currency("USD") %}selected{% endif %}>US Dollar ($)</option>
                        <option value="EUR" {% if settings.is_currency("EUR") %}selected{% endif %}>Euro (€)</option>
                        <option value="GBP" {% if settings.is_currency("GBP") %}selected{% endif %}>British Pound (£)</option>
                        <option value="JPY" {% if settings.is_currency("JPY") %}selected{% endif %}>Japanese Yen (¥)</option>
                        <option value="CAD" {% if settings.is_currency("CAD") %}selected{% endif %}>Canadian Dollar (C$)</option>
                        <option value="AUD" {% if settings.is_currency("AUD") %}selected{% endif %}>Australian Dollar (A$)</option>
                        <option value="CHF" {% if settings.is_currency("CHF") %}selected{% endif %}>Swiss Franc (CHF)</option>
                        <option value="CNY" {% if settings.is_currency("CNY") %}selected{% endif %}>Chinese Yuan (¥)</option>
                        <option value="INR" {% if settings.is_currency("INR") %}selected{% endif %}>Indian Rupee (₹)</option>
                        <option value="BRL" {% if settings.is_currency("BRL") %}selected{% endif %}>Brazilian Real (R$)</option>
                        <option value="MXN" {% if settings.is_currency("MXN") %}selected{% endif %}>Mexican Peso (MX$)</option>
                    </select>
                {% endcall %}

                {% call ui::field(label="Date Format", id="date_format") %}
                    <select id="date_format" name="date_format" class="input w-full">
                        <option value="YYYY-MM-DD" {% if settings.is_date_format("YYYY-MM-DD") %}selected{% endif %}>2024-01-15</option>
                        <option value="MM/DD/YYYY" {% if settings.is_date_format("MM/DD/YYYY") %}selected{% endif %}>01/15/2024</option>
                        <option value="DD/MM/YYYY" {% if settings.is_date_format("DD/MM/YYYY") %}selected{% endif %}>15/01/2024</option>
                    </select>
                {% endcall %}

                {% call ui::field(label="Locale", id="locale") %}
                    <select id="locale" name="locale" class="input w-full">
                        <option value="en-US" {% if settings.is_locale("en-US") %}selected{% endif %}>English (US)</option>
                        <option value="en-GB" {% if settings.is_locale("en-GB") %}selected{% endif %}>English (UK)</option>
                        <option value="de-DE" {% if settings.is_locale("de-DE") %}selected{% endif %}>German</option>
                        <option value="fr-FR" {% if settings.is_locale("fr-FR") %}selected{% endif %}>French</option>
                        <option value="es-ES" {% if settings.is_locale("es-ES") %}selected{% endif %}>Spanish</option>
                    </select>
                {% endcall %}
            </div>
        {% endcall %}

        {# Display #}
        {% call ui::section(title="Display") %}
            {% call ui::field(label="Items per Page", id="page_size") %}
                <select id="page_size" name="page_size" class="input w-full max-w-xs">
                    <option value="10" {% if settings.page_size == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if settings.page_size == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if settings.page_size == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if settings.page_size == 100 %}selected{% endif %}>100</option>
                </select>
            {% endcall %}
        {% endcall %}

        <div id="settings-message"></div>

        <button type="submit" class="btn btn-primary">
            <span class="btn-spinner icon-sm animate-spin" aria-hidden="true">{{ icons.get("loader-circle")|safe }}</span>
            <span class="btn-label">Save Settings</span>
        </button>
    </form>

    {# Database - outside the form since it has its own actions #}
    {% call ui::section(title="Database", class="max-w-2xl", card_class="p-6 space-y-6") %}
        <div>
            <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-1">Database Size</p>
            <p class="text-lg font-medium">{{ database_size }}</p>
        </div>

        <div class="border-t border-neutral-200 dark:border-neutral-700 pt-6">
            <h3 class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3">Export</h3>
            <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-3">Download a full backup of your database.</p>
            <a href="/settings/export-database" class="btn btn-secondary">
                Download Backup
            </a>
        </div>

        <div class="border-t border-neutral-200 dark:border-neutral-700 pt-6">
            <h3 class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3">Import</h3>
            <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-3">
                Restore from a backup file. <strong class="text-red-600 dark:text-red-400">Warning:</strong> This will overwrite all existing data.
            </p>
            <form hx-post="/settings/import-database" hx-target="#import-message" hx-swap="innerHTML" hx-encoding="multipart/form-data" hx-disabled-elt="find button[type='submit']"
                hx-confirm="Are you sure? This will overwrite ALL existing data.">
                <div class="flex items-center gap-4">
                    <input type="file" name="file" accept=".db,.sql" required
                        class="text-sm text-neutral-600 dark:text-neutral-400
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-lg file:border-0
                            file:text-sm file:font-medium
                            file:bg-neutral-100 file:text-neutral-700
                            dark:file:bg-neutral-700 dark:file:text-neutral-200
                            file:cursor-pointer file:transition-colors
                            hover:file:bg-neutral-200 dark:hover:file:bg-neutral-600">
                    <button type="submit" class="btn btn-danger border border-red-700">
                        <span class="btn-spinner icon-sm animate-spin" aria-hidden="true">{{ icons.get("loader-circle")|safe }}</span>
                        <span class="btn-label">Restore Backup</span>
                    </button>
                </div>
            </form>
            <div id="import-message" class="mt-4"></div>
        </div>

        <div class="border-t border-neutral-200 dark:border-neutral-700 pt-6">
            <h3 class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3">Clear Database</h3>
            <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-3">
                Delete all data from the database. <strong class="text-red-600 dark:text-red-400">Warning:</strong> This will permanently remove all transactions, categories, accounts, and other data. The database structure will be preserved.
            </p>
            {% call ui::delete_action_reload(endpoint="/settings/clear-database", confirm="Are you sure you want to clear the ENTIRE database? All data will be permanently deleted. This cannot be undone.", label="Clear Database") %}{% endcall %}
        </div>
    {% endcall %}
</div>
{% endblock %}
