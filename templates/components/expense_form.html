<div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-lg w-full p-6">
    <button onclick="document.getElementById('expense-modal').classList.add('hidden')"
        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
    </button>

    <h2 class="text-xl font-bold mb-6">{% if is_edit %}Edit Expense{% else %}Add Expense{% endif %}</h2>

    {% if let Some(exp) = expense %}
    <form hx-post="/expenses/{{ exp.expense.id }}/update" hx-target="#expense-{{ exp.expense.id }}" hx-swap="outerHTML"
        hx-on::after-request="if(event.detail.successful) document.getElementById('expense-modal').classList.add('hidden')"
        class="space-y-4">

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label>
                <input type="date" name="date" required value="{{ exp.expense.date }}"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Amount</label>
                <input type="number" name="amount" step="0.01" required value="{{ exp.amount_display() }}"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Currency</label>
                <select name="currency" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">
                    <option value="USD" {% if exp.is_currency("USD") %}selected{% endif %}>USD</option>
                    <option value="EUR" {% if exp.is_currency("EUR") %}selected{% endif %}>EUR</option>
                    <option value="GBP" {% if exp.is_currency("GBP") %}selected{% endif %}>GBP</option>
                    <option value="JPY" {% if exp.is_currency("JPY") %}selected{% endif %}>JPY</option>
                    <option value="CAD" {% if exp.is_currency("CAD") %}selected{% endif %}>CAD</option>
                    <option value="AUD" {% if exp.is_currency("AUD") %}selected{% endif %}>AUD</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
                <select name="category_id" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">
                    <option value="">No Category</option>
                    {% for cat in categories %}
                    <option value="{{ cat.category.id }}" {% if exp.matches_category(cat.category.id) %}selected{% endif %}>
                        {{ cat.display_name() }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
            <input type="text" name="description" required value="{{ exp.expense.description }}"
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes (optional)</label>
            <textarea name="notes" rows="2"
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">{{ exp.notes_text() }}</textarea>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tags</label>
            <div class="flex flex-wrap gap-2 mb-2">
                {% for tag in tags %}
                <label class="inline-flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" name="tag_ids" value="{{ tag.id }}" {% if exp.has_tag(tag.id) %}checked{% endif %}
                        class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500">
                    <span class="text-sm px-2 py-0.5 rounded" style="background-color: {{ tag.color }}20; color: {{ tag.color }};">{{ tag.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="flex gap-3 pt-4">
            <button type="button" onclick="document.getElementById('expense-modal').classList.add('hidden')"
                class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                Cancel
            </button>
            <button type="submit"
                class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                Update
            </button>
        </div>
    </form>
    {% else %}
    <form hx-post="/expenses/create" hx-target="#expense-table tbody" hx-swap="afterbegin"
        hx-on::after-request="if(event.detail.successful) document.getElementById('expense-modal').classList.add('hidden')"
        class="space-y-4">

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label>
                <input type="date" name="date" required
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Amount</label>
                <input type="number" name="amount" step="0.01" required
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Currency</label>
                <select name="currency" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">
                    <option value="USD" selected>USD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="JPY">JPY</option>
                    <option value="CAD">CAD</option>
                    <option value="AUD">AUD</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
                <select name="category_id" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">
                    <option value="">No Category</option>
                    {% for cat in categories %}
                    <option value="{{ cat.category.id }}">{{ cat.display_name() }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
            <input type="text" name="description" required
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500">
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes (optional)</label>
            <textarea name="notes" rows="2"
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500"></textarea>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tags</label>
            <div class="flex flex-wrap gap-2 mb-2">
                {% for tag in tags %}
                <label class="inline-flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" name="tag_ids" value="{{ tag.id }}"
                        class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500">
                    <span class="text-sm px-2 py-0.5 rounded" style="background-color: {{ tag.color }}20; color: {{ tag.color }};">{{ tag.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="flex gap-3 pt-4">
            <button type="button" onclick="document.getElementById('expense-modal').classList.add('hidden')"
                class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                Cancel
            </button>
            <button type="submit"
                class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                Add
            </button>
        </div>
    </form>
    {% endif %}
</div>
