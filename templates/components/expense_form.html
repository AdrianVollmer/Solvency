<div class="relative bg-white dark:bg-neutral-800 rounded-xl shadow-xl max-w-lg w-full p-6">
    <button onclick="document.getElementById('expense-modal').classList.add('hidden')"
        class="absolute top-4 right-4 p-2 text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-700 rounded-lg transition-colors"
        aria-label="Close modal">
        <span class="icon-sm" aria-hidden="true">{{ icons.get("x")|safe }}</span>
    </button>

    <h2 class="section-title mb-6">{% if is_edit %}Edit Expense{% else %}Add Expense{% endif %}</h2>

    {% if let Some(exp) = expense %}
    <form hx-post="/expenses/{{ exp.expense.id }}/update" hx-target="#expense-{{ exp.expense.id }}" hx-swap="outerHTML"
        hx-on::after-request="if(event.detail.successful) document.getElementById('expense-modal').classList.add('hidden')"
        class="space-y-4">

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="edit-date" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Date</label>
                <input type="date" id="edit-date" name="date" required value="{{ exp.expense.date }}"
                    class="input w-full">
            </div>
            <div>
                <label for="edit-amount" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Amount</label>
                <input type="number" id="edit-amount" name="amount" step="0.01" required value="{{ exp.amount_display() }}"
                    class="input w-full">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="edit-currency" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Currency</label>
                <select id="edit-currency" name="currency" class="input w-full">
                    <option value="USD" {% if exp.is_currency("USD") %}selected{% endif %}>USD</option>
                    <option value="EUR" {% if exp.is_currency("EUR") %}selected{% endif %}>EUR</option>
                    <option value="GBP" {% if exp.is_currency("GBP") %}selected{% endif %}>GBP</option>
                    <option value="JPY" {% if exp.is_currency("JPY") %}selected{% endif %}>JPY</option>
                    <option value="CAD" {% if exp.is_currency("CAD") %}selected{% endif %}>CAD</option>
                    <option value="AUD" {% if exp.is_currency("AUD") %}selected{% endif %}>AUD</option>
                </select>
            </div>
            <div>
                <label for="edit-category" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Category</label>
                <select id="edit-category" name="category_id" class="input w-full">
                    <option value="">No Category</option>
                    {% for cat in categories %}
                    <option value="{{ cat.category.id }}" {% if exp.matches_category(cat.category.id) %}selected{% endif %}>
                        {{ cat.display_name() }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div>
            <label for="edit-description" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Description</label>
            <input type="text" id="edit-description" name="description" required value="{{ exp.expense.description }}"
                class="input w-full">
        </div>

        <div>
            <label for="edit-notes" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Notes (optional)</label>
            <textarea id="edit-notes" name="notes" rows="2"
                class="input w-full">{{ exp.notes_text() }}</textarea>
        </div>

        <fieldset>
            <legend class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Tags</legend>
            <div class="flex flex-wrap gap-2">
                {% for tag in tags %}
                <label class="inline-flex items-center gap-1.5 cursor-pointer">
                    <input type="checkbox" name="tag_ids" value="{{ tag.id }}" {% if exp.has_tag(tag.id) %}checked{% endif %}
                        class="w-4 h-4 text-primary-600 rounded border-neutral-300 focus:ring-primary-500">
                    <span class="text-sm px-2 py-0.5 rounded" style="background-color: {{ tag.color }}20; color: {{ tag.color }};">{{ tag.name }}</span>
                </label>
                {% endfor %}
            </div>
        </fieldset>

        <div class="flex gap-3 pt-4">
            <button type="button" onclick="document.getElementById('expense-modal').classList.add('hidden')"
                class="btn btn-secondary flex-1">
                Cancel
            </button>
            <button type="submit" class="btn btn-primary flex-1">
                Update
            </button>
        </div>
    </form>
    {% else %}
    <form hx-post="/expenses/create" hx-target="#expense-table tbody" hx-swap="afterbegin"
        hx-on::after-request="if(event.detail.successful) document.getElementById('expense-modal').classList.add('hidden')"
        class="space-y-4">

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="new-date" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Date</label>
                <input type="date" id="new-date" name="date" required
                    class="input w-full">
            </div>
            <div>
                <label for="new-amount" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Amount</label>
                <input type="number" id="new-amount" name="amount" step="0.01" required
                    class="input w-full">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="new-currency" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Currency</label>
                <select id="new-currency" name="currency" class="input w-full">
                    <option value="USD" selected>USD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="JPY">JPY</option>
                    <option value="CAD">CAD</option>
                    <option value="AUD">AUD</option>
                </select>
            </div>
            <div>
                <label for="new-category" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Category</label>
                <select id="new-category" name="category_id" class="input w-full">
                    <option value="">No Category</option>
                    {% for cat in categories %}
                    <option value="{{ cat.category.id }}">{{ cat.display_name() }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div>
            <label for="new-description" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Description</label>
            <input type="text" id="new-description" name="description" required
                class="input w-full">
        </div>

        <div>
            <label for="new-notes" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Notes (optional)</label>
            <textarea id="new-notes" name="notes" rows="2"
                class="input w-full"></textarea>
        </div>

        <fieldset>
            <legend class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Tags</legend>
            <div class="flex flex-wrap gap-2">
                {% for tag in tags %}
                <label class="inline-flex items-center gap-1.5 cursor-pointer">
                    <input type="checkbox" name="tag_ids" value="{{ tag.id }}"
                        class="w-4 h-4 text-primary-600 rounded border-neutral-300 focus:ring-primary-500">
                    <span class="text-sm px-2 py-0.5 rounded" style="background-color: {{ tag.color }}20; color: {{ tag.color }};">{{ tag.name }}</span>
                </label>
                {% endfor %}
            </div>
        </fieldset>

        <div class="flex gap-3 pt-4">
            <button type="button" onclick="document.getElementById('expense-modal').classList.add('hidden')"
                class="btn btn-secondary flex-1">
                Cancel
            </button>
            <button type="submit" class="btn btn-primary flex-1">
                Add
            </button>
        </div>
    </form>
    {% endif %}
</div>
